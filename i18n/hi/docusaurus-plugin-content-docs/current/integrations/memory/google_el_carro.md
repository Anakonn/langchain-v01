---
translated: true
---

# рдЧреВрдЧрд▓ рдПрд▓ рдХреИрд░реЛ рдУрд░реЗрдХрд▓

> [рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рдПрд▓ рдХреИрд░реЛ рдУрд░реЗрдХрд▓](https://github.com/GoogleCloudPlatform/elcarro-oracle-operator) `рдХреБрдмрд░рдиреЗрдЯреАрдЬрд╝` рдореЗрдВ `рдУрд░реЗрдХрд▓` рдбреЗрдЯрд╛рдмреЗрд╕ рдЪрд▓рд╛рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдПрдХ рдкреЛрд░реНрдЯреЗрдмрд▓, рдУрдкрди рд╕реЛрд░реНрд╕, рд╕рдореБрджрд╛рдп-рд╕рдВрдЪрд╛рд▓рд┐рдд, рдХреЛрдИ рд╡реЗрдВрдбрд░ рд▓реЙрдХ-рдЗрди рдХрдВрдЯреЗрдирд░ рдСрд░реНрдХреЗрд╕реНрдЯреНрд░реЗрд╢рди рд╕рд┐рд╕реНрдЯрдо рд╣реИред `рдПрд▓ рдХреИрд░реЛ` рд╡реНрдпрд╛рдкрдХ рдФрд░ рд╕реБрд╕рдВрдЧрдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдФрд░ рдбреЗрдкреНрд▓реЙрдпрдореЗрдВрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рдШреЛрд╖рдгрд╛рддреНрдордХ API рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рд╕рд╛рде рд╣реА рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдХреА рдкрд░рд┐рдЪрд╛рд▓рди рдФрд░ рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рднреАред `рдПрд▓ рдХреИрд░реЛ` рд▓реИрдВрдЧрдЪреЗрди рдПрдХреАрдХрд░рдг рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдХрд░ рдЕрдкрдиреЗ `рдУрд░реЗрдХрд▓` рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░реЗрдВ рдФрд░ AI-рд╕рдВрдЪрд╛рд▓рд┐рдд рдЕрдиреБрднрд╡ рдмрдирд╛рдПрдВред

рдпрд╣ рдЧрд╛рдЗрдб `рдПрд▓ рдХреИрд░реЛ` рд▓реИрдВрдЧрдЪреЗрди рдПрдХреАрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `ElCarroChatMessageHistory` рдХреНрд▓рд╛рд╕ рдХреЗ рд╕рд╛рде рдЪреИрдЯ рд╕рдВрджреЗрд╢ рдЗрддрд┐рд╣рд╛рд╕ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рддрд╛ рд╣реИред рдпрд╣ рдПрдХреАрдХрд░рдг рдХрд┐рд╕реА рднреА `рдУрд░реЗрдХрд▓` рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рднрд▓реЗ рд╣реА рд╡рд╣ рдХрд╣реАрдВ рднреА рдЪрд▓ рд░рд╣рд╛ рд╣реЛред

рдкреИрдХреЗрдЬ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [GitHub](https://github.com/googleapis/langchain-google-el-carro-python/) рдкрд░ рдорд┐рд▓рддреА рд╣реИред

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/googleapis/langchain-google-el-carro-python/blob/main/docs/chat_message_history.ipynb)

## рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ

рдЗрд╕ рдиреЛрдЯрдмреБрдХ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдп рдХрд░рдиреЗ рд╣реЛрдВрдЧреЗ:

 * рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдУрд░реЗрдХрд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рдПрд▓ рдХреИрд░реЛ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ [рд╢реБрд░реВ рдХрд░рдирд╛](https://github.com/googleapis/langchain-google-el-carro-python/tree/main/README.md#getting-started) рдЦрдВрдб рдкреВрд░рд╛ рдХрд░реЗрдВред

### ЁЯжЬЁЯФЧ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди

рдПрдХреАрдХрд░рдг `langchain-google-el-carro` рдкреИрдХреЗрдЬ рдореЗрдВ рдореМрдЬреВрдж рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдЗрд╕реЗ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

```python
%pip install --upgrade --quiet langchain-google-el-carro langchain-google-vertexai langchain
```

**рдХреЗрд╡рд▓ Colab:** рдХрд░реНрдирд▓ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрд╢рд┐рдХрд╛ рдХреЛ рдЕрдирдХрдореЗрдВрдЯ рдХрд░реЗрдВ рдпрд╛ рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред Vertex AI Workbench рдХреЗ рд▓рд┐рдП, рд╢реАрд░реНрд╖ рдкрд░ рджрд┐рдП рдЧрдП рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯрд░реНрдорд┐рдирд▓ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рд░рдВрдн рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

```python
# # Automatically restart kernel after installs so that your environment can access the new packages
# import IPython

# app = IPython.Application.instance()
# app.kernel.do_shutdown(True)
```

### ЁЯФР рдкреНрд░рдорд╛рдгреАрдХрд░рдг

рдЗрд╕ рдиреЛрдЯрдмреБрдХ рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд┐рдП рдЧрдП IAM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЖрдк рдЕрдкрдиреЗ рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рдкреНрд░реЛрдЬреЗрдХреНрдЯ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВред

* рдпрджрд┐ рдЖрдк рдЗрд╕ рдиреЛрдЯрдмреБрдХ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП Colab рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдХреЛрд╢рд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рдЖрдЧреЗ рдмрдврд╝реЗрдВред
* рдпрджрд┐ рдЖрдк Vertex AI Workbench рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ [рдпрд╣рд╛рдВ](https://github.com/GoogleCloudPlatform/generative-ai/tree/main/setup-env) рджрд┐рдП рдЧрдП рд╕реЗрдЯрдЕрдк рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред

```python
# from google.colab import auth

# auth.authenticate_user()
```

### тШБ рдЕрдкрдиреЗ рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реЗрдЯ рдХрд░реЗрдВ

рдЕрдкрдиреЗ рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЛ рд╕реЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЖрдк рдЗрд╕ рдиреЛрдЯрдмреБрдХ рдореЗрдВ рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХреЗрдВред

рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЖрдИрдбреА рдХреЛ рдирд╣реАрдВ рдЬрд╛рдирддреЗ рд╣реИрдВ, рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ:

* `gcloud config list` рдЪрд▓рд╛рдПрдВред
* `gcloud projects list` рдЪрд▓рд╛рдПрдВред
* рд╕рд╣рд╛рдпрддрд╛ рдкреГрд╖реНрда рджреЗрдЦреЗрдВ: [рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЖрдИрдбреА рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ](https://support.google.com/googleapi/answer/7014113)ред

```python
# @markdown Please fill in the value below with your Google Cloud project ID and then run the cell.

PROJECT_ID = "my-project-id"  # @param {type:"string"}

# Set the project id
!gcloud config set project {PROJECT_ID}
```

## рдореВрд▓рднреВрдд рдЙрдкрдпреЛрдЧ

### рдУрд░реЗрдХрд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди рд╕реЗрдЯ рдХрд░реЗрдВ

рдЕрдкрдиреЗ рдУрд░реЗрдХрд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди рд╡рд┐рд╡рд░рдг рдХреЗ рд╕рд╛рде рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд░ рднрд░реЗрдВред

```python
# @title Set Your Values Here { display-mode: "form" }
HOST = "127.0.0.1"  # @param {type: "string"}
PORT = 3307  # @param {type: "integer"}
DATABASE = "my-database"  # @param {type: "string"}
TABLE_NAME = "message_store"  # @param {type: "string"}
USER = "my-user"  # @param {type: "string"}
PASSWORD = input("Please provide a password to be used for the database user: ")
```

рдпрджрд┐ рдЖрдк `рдПрд▓ рдХреИрд░реЛ` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдЖрдк рд╣реЛрд╕реНрдЯрдирд╛рдо рдФрд░ рдкреЛрд░реНрдЯ рдорд╛рди `рдПрд▓ рдХреИрд░реЛ` Kubernetes рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред
рдЕрдкрдиреЗ PDB рдХреЗ рд▓рд┐рдП рдмрдирд╛рдП рдЧрдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
рдЙрджрд╛рд╣рд░рдг

kubectl get -w instances.oracle.db.anthosapis.com -n db
NAME   DB ENGINE   VERSION   EDITION      ENDPOINT      URL                DB NAMES   BACKUP ID   READYSTATUS   READYREASON        DBREADYSTATUS   DBREADYREASON
mydb   Oracle      18c       Express      mydb-svc.db   34.71.69.25:6021                          False         CreateInProgress

### ElCarroEngine рдХрдиреЗрдХреНрд╢рди рдкреВрд▓

`ElCarroEngine` рдЖрдкрдХреЗ рдУрд░реЗрдХрд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдиреЗрдХреНрд╢рди рдкреВрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЖрдкрдХреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реЗ рд╕рдлрд▓ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЙрджреНрдпреЛрдЧ рдХреА рд╕рд░реНрд╡рд╢реНрд░реЗрд╖реНрда рдкреНрд░рдерд╛рдУрдВ рдХрд╛ рдкрд╛рд▓рди рд╣реЛрддрд╛ рд╣реИред

```python
from langchain_google_el_carro import ElCarroEngine

elcarro_engine = ElCarroEngine.from_instance(
    db_host=HOST,
    db_port=PORT,
    db_name=DATABASE,
    db_user=USER,
    db_password=PASSWORD,
)
```

### рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░реЗрдВ

`ElCarroChatMessageHistory` рдХреНрд▓рд╛рд╕ рдХреЛ рдЪреИрдЯ рд╕рдВрджреЗрд╢ рдЗрддрд┐рд╣рд╛рд╕ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕реНрдХреАрдорд╛ рдХреЗ рд╕рд╛рде рдПрдХ рдбреЗрдЯрд╛рдмреЗрд╕ рддрд╛рд▓рд┐рдХрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

`ElCarroEngine` рдХреНрд▓рд╛рд╕ рдореЗрдВ рдПрдХ `init_chat_history_table()` рдореЗрдердб рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЖрдк рдЗрд╕ рддрд╛рд▓рд┐рдХрд╛ рдХреЛ рдЖрдкрдХреЗ рд▓рд┐рдП рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

```python
elcarro_engine.init_chat_history_table(table_name=TABLE_NAME)
```

### ElCarroChatMessageHistory

`ElCarroChatMessageHistory` рдХреНрд▓рд╛рд╕ рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдХреЗрд╡рд▓ 3 рдЪреАрдЬреЗрдВ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

1. `elcarro_engine` - рдПрдХ `ElCarroEngine` рдЗрдВрдЬрди рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдгред
1. `session_id` - рдПрдХ рдЕрджреНрд╡рд┐рддреАрдп рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдЬреЛ рд╕рддреНрд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдЖрдИрдбреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИред
1. `table_name` : рдУрд░реЗрдХрд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЪреИрдЯ рд╕рдВрджреЗрд╢ рдЗрддрд┐рд╣рд╛рд╕ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рдирд╛рдоред

```python
from langchain_google_el_carro import ElCarroChatMessageHistory

history = ElCarroChatMessageHistory(
    elcarro_engine=elcarro_engine, session_id="test_session", table_name=TABLE_NAME
)
history.add_user_message("hi!")
history.add_ai_message("whats up?")
```

```python
history.messages
```

#### рд╕рдлрд╛рдИ рдХрд░рдирд╛

рдЬрдм рдХрд┐рд╕реА рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рддреНрд░ рдХрд╛ рдЗрддрд┐рд╣рд╛рд╕ рдкреБрд░рд╛рдирд╛ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

**рдиреЛрдЯ:** рдПрдХ рдмрд╛рд░ рд╣рдЯрд╛ рджрд┐рдП рдЬрд╛рдиреЗ рдкрд░, рдбреЗрдЯрд╛ рдЖрдкрдХреЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдирд╣реАрдВ рд░рд╣рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рд╣рдореЗрд╢рд╛ рдХреЗ рд▓рд┐рдП рдЦреЛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

```python
history.clear()
```

## ЁЯФЧ рд╢реНрд░реГрдВрдЦрд▓рд╛рдмрджреНрдз рдХрд░рдирд╛

рд╣рдо рдЖрд╕рд╛рдиреА рд╕реЗ рдЗрд╕ рд╕рдВрджреЗрд╢ рдЗрддрд┐рд╣рд╛рд╕ рд╡рд░реНрдЧ рдХреЛ [LCEL Runnables](/docs/expression_language/how_to/message_history) рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ

рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдо [рдЧреВрдЧрд▓ рдХреЗ Vertex AI рдЪреИрдЯ рдореЙрдбрд▓](/docs/integrations/chat/google_vertex_ai_palm) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ [Vertex AI API рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛](https://console.cloud.google.com/flows/enableapi?apiid=aiplatform.googleapis.com) рд╣реЛрдЧрд╛ред

```python
# enable Vertex AI API
!gcloud services enable aiplatform.googleapis.com
```

```python
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_google_vertexai import ChatVertexAI
```

```python
prompt = ChatPromptTemplate.from_messages(
    [
        ("system", "You are a helpful assistant."),
        MessagesPlaceholder(variable_name="history"),
        ("human", "{question}"),
    ]
)

chain = prompt | ChatVertexAI(project=PROJECT_ID)
```

```python
chain_with_history = RunnableWithMessageHistory(
    chain,
    lambda session_id: ElCarroChatMessageHistory(
        elcarro_engine,
        session_id=session_id,
        table_name=TABLE_NAME,
    ),
    input_messages_key="question",
    history_messages_key="history",
)
```

```python
# This is where we configure the session id
config = {"configurable": {"session_id": "test_session"}}
```

```python
chain_with_history.invoke({"question": "Hi! I'm bob"}, config=config)
```

```python
chain_with_history.invoke({"question": "Whats my name"}, config=config)
```
