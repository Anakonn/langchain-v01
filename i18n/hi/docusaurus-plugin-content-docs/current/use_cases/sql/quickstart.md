---
sidebar_position: 0
translated: true
---

рдпрд╣ рдЧрд╛рдЗрдб рдореЗрдВ рд╣рдо SQL рдбреЗрдЯрд╛рдмреЗрд╕ рдкрд░ рдПрдХ рдкреНрд░рд╢реНрди рдФрд░ рдЙрддреНрддрд░ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдФрд░ рдПрдЬреЗрдВрдЯ рдмрдирд╛рдиреЗ рдХреЗ рдореВрд▓рднреВрдд рддрд░реАрдХреЛрдВ рдкрд░ рдЪрд░реНрдЪрд╛ рдХрд░реЗрдВрдЧреЗред рдпреЗ рдкреНрд░рдгрд╛рд▓реА рд╣рдореЗрдВ SQL рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдбреЗрдЯрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреНрд░рд╢реНрди рдкреВрдЫрдиреЗ рдФрд░ рдкреНрд░рд╛рдХреГрддрд┐рдХ рднрд╛рд╖рд╛ рдореЗрдВ рдЙрддреНрддрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рдПрдВрдЧреАред рджреЛрдиреЛрдВ рдХреЗ рдмреАрдЪ рдореБрдЦреНрдп рдЕрдВрддрд░ рдпрд╣ рд╣реИ рдХрд┐ рд╣рдорд╛рд░рд╛ рдПрдЬреЗрдВрдЯ рдкреНрд░рд╢реНрди рдХрд╛ рдЙрддреНрддрд░ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рддрдиреА рдмрд╛рд░ рдЬрд░реВрд░рдд рд╣реЛ, рдЙрддрдиреА рдмрд╛рд░ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдХреНрд╡реЗрд░реА рдХрд░ рд╕рдХрддрд╛ рд╣реИред

## тЪая╕П рд╕реБрд░рдХреНрд╖рд╛ рдиреЛрдЯ тЪая╕П

SQL рдбреЗрдЯрд╛рдмреЗрд╕ рдкрд░ рдкреНрд░рд╢реНрди рдФрд░ рдЙрддреНрддрд░ рдкреНрд░рдгрд╛рд▓реА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдореЙрдбрд▓-рдЬрдирд┐рдд SQL рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдРрд╕рд╛ рдХрд░рдиреЗ рдореЗрдВ рдХреБрдЫ рдЬреЛрдЦрд┐рдо рд╣реИрдВред рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЖрдкрдХреЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣рдореЗрд╢рд╛ рдЖрдкрдХреЗ рд╢реНрд░реГрдВрдЦрд▓рд╛/рдПрдЬреЗрдВрдЯ рдХреА рдЬрд░реВрд░рддреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдВрдХреАрд░реНрдг рд╣реЛрдВред рдЗрд╕рд╕реЗ рдЬреЛрдЦрд┐рдо рдХрдо рд╣реЛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛрдЧрд╛ред рд╕рд╛рдорд╛рдиреНрдп рд╕реБрд░рдХреНрд╖рд╛ рд╕рд░реНрд╡реЛрддреНрддрдо рдкреНрд░рдерд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП, [рдпрд╣рд╛рдВ рджреЗрдЦреЗрдВ](/docs/security)ред

## рд╡рд╛рд╕реНрддреБрдХрд▓рд╛

рдХрд┐рд╕реА рднреА SQL рд╢реНрд░реГрдВрдЦрд▓рд╛ рдФрд░ рдПрдЬреЗрдВрдЯ рдХреЗ рдЙрдЪреНрдЪ рд╕реНрддрд░ рдкрд░, рдЪрд░рдг рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИрдВ:

1. **рдкреНрд░рд╢реНрди рдХреЛ SQL рдХреНрд╡реЗрд░реА рдореЗрдВ рдмрджрд▓рдирд╛**: рдореЙрдбрд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЗрдирдкреБрдЯ рдХреЛ SQL рдХреНрд╡реЗрд░реА рдореЗрдВ рдмрджрд▓рддрд╛ рд╣реИред
2. **SQL рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛**: SQL рдХреНрд╡реЗрд░реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВред
3. **рдкреНрд░рд╢реНрди рдХрд╛ рдЙрддреНрддрд░ рджреЗрдирд╛**: рдореЙрдбрд▓ рдХреНрд╡реЗрд░реА рдкрд░рд┐рдгрд╛рдореЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЗрдирдкреБрдЯ рдХрд╛ рдЙрддреНрддрд░ рджреЗрддрд╛ рд╣реИред

![sql_usecase.png](../../../../../../static/img/sql_usecase.png)

## рд╕реЗрдЯрдЕрдк

рдкрд╣рд▓реЗ, рдЖрд╡рд╢реНрдпрдХ рдкреИрдХреЗрдЬ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ рд╡рд╛рддрд╛рд╡рд░рдг рдЪрд░ рд╕реЗрдЯ рдХрд░реЗрдВ:

```python
%pip install --upgrade --quiet  langchain langchain-community langchain-openai
```

рд╣рдо рдЗрд╕ рдЧрд╛рдЗрдб рдореЗрдВ OpenAI рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред

```python
import getpass
import os

os.environ["OPENAI_API_KEY"] = getpass.getpass()

# Uncomment the below to use LangSmith. Not required.
# os.environ["LANGCHAIN_API_KEY"] = getpass.getpass()
# os.environ["LANGCHAIN_TRACING_V2"] = "true"
```

рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ рдЙрджрд╛рд╣рд░рдг SQLite рдХрдиреЗрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ Chinook рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рдеред [рдпреЗ рд╕реНрдерд╛рдкрдирд╛ рдЪрд░рдг](https://database.guide/2-sample-databases-sqlite/) рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ `Chinook.db` рдХреЛ рдЗрд╕реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП:

* [рдпрд╣ рдлрд╝рд╛рдЗрд▓](https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite.sql) рдХреЛ `Chinook_Sqlite.sql` рдХреЗ рд░реВрдк рдореЗрдВ рд╕рд╣реЗрдЬреЗрдВ
* `sqlite3 Chinook.db` рдЪрд▓рд╛рдПрдВ
* `.read Chinook_Sqlite.sql` рдЪрд▓рд╛рдПрдВ
* `SELECT * FROM Artist LIMIT 10;` рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ

рдЕрдм, `Chinhook.db` рд╣рдорд╛рд░реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╣реИ рдФрд░ рд╣рдо рдЗрд╕реЗ SQLAlchemy-driven `SQLDatabase` рд╡рд░реНрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```python
from langchain_community.utilities import SQLDatabase

db = SQLDatabase.from_uri("sqlite:///Chinook.db")
print(db.dialect)
print(db.get_usable_table_names())
db.run("SELECT * FROM Artist LIMIT 10;")
```

```output
sqlite
['Album', 'Artist', 'Customer', 'Employee', 'Genre', 'Invoice', 'InvoiceLine', 'MediaType', 'Playlist', 'PlaylistTrack', 'Track']
```

```output
"[(1, 'AC/DC'), (2, 'Accept'), (3, 'Aerosmith'), (4, 'Alanis Morissette'), (5, 'Alice In Chains'), (6, 'Ant├┤nio Carlos Jobim'), (7, 'Apocalyptica'), (8, 'Audioslave'), (9, 'BackBeat'), (10, 'Billy Cobham')]"
```

рдмрдврд╝рд┐рдпрд╛! рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ SQL рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реИ рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╣рдо рдХреНрд╡реЗрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдм рдЗрд╕реЗ рдПрдХ LLM рд╕реЗ рдЬреЛрдбрд╝рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред

## рд╢реНрд░реГрдВрдЦрд▓рд╛

рдПрдХ рд╕рд░рд▓ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛рддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рдкреНрд░рд╢реНрди рд▓реЗрддрд╛ рд╣реИ, рдЗрд╕реЗ SQL рдХреНрд╡реЗрд░реА рдореЗрдВ рдмрджрд▓рддрд╛ рд╣реИ, рдХреНрд╡реЗрд░реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдореВрд▓ рдкреНрд░рд╢реНрди рдХрд╛ рдЙрддреНрддрд░ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рдгрд╛рдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред

### рдкреНрд░рд╢реНрди рдХреЛ SQL рдХреНрд╡реЗрд░реА рдореЗрдВ рдмрджрд▓рдирд╛

рдХрд┐рд╕реА SQL рд╢реНрд░реГрдВрдЦрд▓рд╛ рдпрд╛ рдПрдЬреЗрдВрдЯ рдореЗрдВ рдкрд╣рд▓рд╛ рдХрджрдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЗрдирдкреБрдЯ рдХреЛ рд▓реЗрдирд╛ рдФрд░ рдЗрд╕реЗ SQL рдХреНрд╡реЗрд░реА рдореЗрдВ рдмрджрд▓рдирд╛ рд╣реИред LangChain рдореЗрдВ рдЗрд╕рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд┐рд▓реНрдЯ-рдЗрди рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╣реИ: [create_sql_query_chain](https://api.python.langchain.com/en/latest/chains/langchain.chains.sql_database.query.create_sql_query_chain.html)ред

```python
from langchain.chains import create_sql_query_chain
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0)
chain = create_sql_query_chain(llm, db)
response = chain.invoke({"question": "How many employees are there"})
response
```

```output
'SELECT COUNT(*) FROM Employee'
```

рд╣рдо рдХреНрд╡реЗрд░реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдпрд╣ рдорд╛рдиреНрдп рд╣реИ:

```python
db.run(response)
```

```output
'[(8,)]'
```

рд╣рдо [LangSmith рдЯреНрд░реЗрд╕](https://smith.langchain.com/public/c8fa52ea-be46-4829-bde2-52894970b830/r) рдХреЛ рджреЗрдЦрдХрд░ рдЗрд╕ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмреЗрд╣рддрд░ рд╕рдордЭ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╣рдо рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЛ рд╕реАрдзреЗ рднреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдЙрд╕рдХреЗ рдкреНрд░реЛрдореНрдкреНрдЯ рдХреЗ рд▓рд┐рдПред рдкреНрд░реЛрдореНрдкреНрдЯ рдХреЛ рджреЗрдЦрдХрд░ (рдиреАрдЪреЗ), рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣:

* рдбрд╛рдпрд▓реЗрдХреНрдЯ-рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╣реИред рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдпрд╣ SQLite рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдХрд░рддрд╛ рд╣реИред
* рд╕рднреА рдЙрдкрд▓рдмреНрдз рддрд╛рд▓рд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рднрд╛рд╖рд╛рдПрдВ рд╣реИрдВред
* рдкреНрд░рддреНрдпреЗрдХ рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рддреАрди рдЙрджрд╛рд╣рд░рдг рдкрдВрдХреНрддрд┐рдпрд╛рдВ рд╣реИрдВред

рдпрд╣ рддрдХрдиреАрдХ рдкреЗрдкрд░ рдЬреИрд╕реЗ [рдЗрд╕](https://arxiv.org/pdf/2204.00498.pdf) рд╕реЗ рдкреНрд░реЗрд░рд┐рдд рд╣реИ, рдЬреЛ рд╕реБрдЭрд╛рд╡ рджреЗрддреА рд╣реИ рдХрд┐ рдЙрджрд╛рд╣рд░рдг рдкрдВрдХреНрддрд┐рдпреЛрдВ рдХреЛ рджрд┐рдЦрд╛рдирд╛ рдФрд░ рддрд╛рд▓рд┐рдХрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реНрдкрд╖реНрдЯ рд╣реЛрдирд╛ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рддрд╛ рд╣реИред рд╣рдо рдкреВрд░реЗ рдкреНрд░реЛрдореНрдкреНрдЯ рдХреЛ рднреА рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:

```python
chain.get_prompts()[0].pretty_print()
```

```output
You are a SQLite expert. Given an input question, first create a syntactically correct SQLite query to run, then look at the results of the query and return the answer to the input question.
Unless the user specifies in the question a specific number of examples to obtain, query for at most 5 results using the LIMIT clause as per SQLite. You can order the results to return the most informative data in the database.
Never query for all columns from a table. You must query only the columns that are needed to answer the question. Wrap each column name in double quotes (") to denote them as delimited identifiers.
Pay attention to use only the column names you can see in the tables below. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which table.
Pay attention to use date('now') function to get the current date, if the question involves "today".

Use the following format:

Question: Question here
SQLQuery: SQL Query to run
SQLResult: Result of the SQLQuery
Answer: Final answer here

Only use the following tables:
[33;1m[1;3m{table_info}[0m

Question: [33;1m[1;3m{input}[0m
```

### SQL рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛

рдЕрдм рдЬрдм рд╣рдордиреЗ рдПрдХ SQL рдХреНрд╡реЗрд░реА рдЬрдирд░реЗрдЯ рдХрд░ рд▓реА рд╣реИ, рддреЛ рд╣рдо рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗред **рдпрд╣ SQL рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЦрддрд░рдирд╛рдХ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИред** рдпрд╣ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдЖрдкрдХреЗ рдбреЗрдЯрд╛ рдкрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХреНрд╡реЗрд░реА рдЪрд▓рд╛рдирд╛ рдареАрдХ рд╣реИред рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдЬрд┐рддрдирд╛ рд╕рдВрднрд╡ рд╣реЛ рдЙрддрдирд╛ рд╕рдВрдХреАрд░реНрдг рдХрд░реЗрдВред рдЕрдкрдиреА рд╢реНрд░реГрдВрдЦрд▓рд╛рдУрдВ рдореЗрдВ рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрди рд╕реЗ рдкрд╣рд▓реЗ рдорд╛рдирд╡ рдЕрдиреБрдореЛрджрди рдЪрд░рдг рдЬреЛрдбрд╝рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ (рдиреАрдЪреЗ рджреЗрдЦреЗрдВ)ред

рд╣рдо `QuerySQLDatabaseTool` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдЕрдкрдиреА рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ:

```python
from langchain_community.tools.sql_database.tool import QuerySQLDataBaseTool

execute_query = QuerySQLDataBaseTool(db=db)
write_query = create_sql_query_chain(llm, db)
chain = write_query | execute_query
chain.invoke({"question": "How many employees are there"})
```

```output
'[(8,)]'
```

### рдкреНрд░рд╢реНрди рдХрд╛ рдЙрддреНрддрд░ рджреЗрдирд╛

рдЕрдм рдЬрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдХреНрд╡реЗрд░реА рдЬрдирд░реЗрдЯ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реИ, рддреЛ рд╣рдореЗрдВ рдмрд╕ рдореВрд▓ рдкреНрд░рд╢реНрди рдФрд░ SQL рдХреНрд╡реЗрд░реА рдкрд░рд┐рдгрд╛рдо рдХреЛ рдПрдХ рдЕрдВрддрд┐рдо рдЙрддреНрддрд░ рдЬрдирд░реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╛рд░ рдлрд┐рд░ LLM рдХреЛ рдкрд╛рд╕ рдХрд░рдирд╛ рд╣реИ:

```python
from operator import itemgetter

from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import PromptTemplate
from langchain_core.runnables import RunnablePassthrough

answer_prompt = PromptTemplate.from_template(
    """Given the following user question, corresponding SQL query, and SQL result, answer the user question.

Question: {question}
SQL Query: {query}
SQL Result: {result}
Answer: """
)

answer = answer_prompt | llm | StrOutputParser()
chain = (
    RunnablePassthrough.assign(query=write_query).assign(
        result=itemgetter("query") | execute_query
    )
    | answer
)

chain.invoke({"question": "How many employees are there"})
```

```output
'There are 8 employees.'
```

### рдЕрдЧрд▓реЗ рдХрджрдо

рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рдХреНрд╡реЗрд░реА-рдЬрдирд░реЗрд╢рди рдХреЗ рд▓рд┐рдП, рд╣рдо рд╢рд╛рдпрдж рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдореНрдкреНрдЯ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдХреНрд╡реЗрд░реА-рдЬрд╛рдВрдЪ рдЪрд░рдг рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рддрд░рд╣ рдХреЗ рдЙрдиреНрдирдд рддрдХрдиреАрдХреЛрдВ рдФрд░ рдЕрдзрд┐рдХ рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

* [рдкреНрд░реЛрдореНрдкреНрдЯрд┐рдВрдЧ рд░рдгрдиреАрддрд┐рдпрд╛рдВ](/docs/use_cases/sql/prompting): рдЙрдиреНрдирдд рдкреНрд░реЛрдореНрдкреНрдЯ рдЗрдВрдЬреАрдирд┐рдпрд░рд┐рдВрдЧ рддрдХрдиреАрдХреЗрдВред
* [рдХреНрд╡реЗрд░реА рдЬрд╛рдВрдЪ](/docs/use_cases/sql/query_checking): рдХреНрд╡реЗрд░реА рдорд╛рдиреНрдпрддрд╛ рдФрд░ рддреНрд░реБрдЯрд┐ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЛ рдЬреЛрдбрд╝реЗрдВред
* [рдмрдбрд╝реЗ рдбреЗрдЯрд╛рдмреЗрд╕](/docs/use_cases/sql/large_db): рдмрдбрд╝реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддрдХрдиреАрдХреЗрдВред

## рдПрдЬреЗрдВрдЯ

LangChain рдореЗрдВ рдПрдХ SQL рдПрдЬреЗрдВрдЯ рд╣реИ рдЬреЛ SQL рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдХ рд▓рдЪреАрд▓реА рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред SQL рдПрдЬреЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдореБрдЦреНрдп рд▓рд╛рдн рд╣реИрдВ:

- рдпрд╣ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕реНрдХреАрдорд╛ рдХреЗ рд╕рд╛рде-рд╕рд╛рде рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рдордЧреНрд░реА (рдЬреИрд╕реЗ рдХрд┐ рдХрд┐рд╕реА рд╡рд┐рд╢рд┐рд╖реНрдЯ рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рд╡рд░реНрдгрди) рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рд╢реНрдиреЛрдВ рдХрд╛ рдЙрддреНрддрд░ рджреЗ рд╕рдХрддрд╛ рд╣реИред
- рдпрд╣ рддреНрд░реБрдЯрд┐рдпреЛрдВ рд╕реЗ рдЙрдмрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЬрдирд░реЗрдЯ рдХреА рдЧрдИ рдХреНрд╡реЗрд░реА рдХреЛ рдЪрд▓рд╛рдХрд░, рдЯреНрд░реЗрд╕рдмреИрдХ рдХреЛ рдкрдХрдбрд╝рдХрд░ рдФрд░ рдЗрд╕реЗ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдкреБрдирдГ рдЬрдирд░реЗрдЯ рдХрд░рдХреЗ рдкреНрд░рд╢реНрдиреЛрдВ рдХрд╛ рдЙрддреНрддрд░ рджреЗ рд╕рдХрддрд╛ рд╣реИред
- рдпрд╣ рдХрдИ рдирд┐рд░реНрднрд░ рдХреНрд╡реЗрд░рд┐рдпреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╡рд╛рд▓реЗ рдкреНрд░рд╢реНрдиреЛрдВ рдХрд╛ рдЙрддреНрддрд░ рджреЗ рд╕рдХрддрд╛ рд╣реИред
- рдпрд╣ рдЯреЛрдХрди рдХреЛ рдмрдЪрд╛рдПрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдХреЗрд╡рд▓ рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рддрд╛рд▓рд┐рдХрд╛рдУрдВ рдХреЗ рд╕реНрдХреАрдорд╛ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдЧрд╛ред

рдПрдЬреЗрдВрдЯ рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо `create_sql_agent` рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред рдпрд╣ рдПрдЬреЗрдВрдЯ `SQLDatabaseToolkit` рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдкрдХрд░рдг рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ:

* рдХреНрд╡реЗрд░реА рдмрдирд╛рдирд╛ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛
* рдХреНрд╡реЗрд░реА рд╡рд╛рдХреНрдпрд╡рд┐рдиреНрдпрд╛рд╕ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдирд╛
* рддрд╛рд▓рд┐рдХрд╛ рд╡рд┐рд╡рд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛
* ... рдФрд░ рдЕрдзрд┐рдХ

### рдПрдЬреЗрдВрдЯ рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдирд╛

```python
from langchain_community.agent_toolkits import create_sql_agent

agent_executor = create_sql_agent(llm, db=db, agent_type="openai-tools", verbose=True)
```

```python
agent_executor.invoke(
    {
        "input": "List the total sales per country. Which country's customers spent the most?"
    }
)
```

```output


[1m> Entering new AgentExecutor chain...[0m
[32;1m[1;3m
Invoking: `sql_db_list_tables` with `{}`


[0m[38;5;200m[1;3mAlbum, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track[0m[32;1m[1;3m
Invoking: `sql_db_schema` with `Invoice,Customer`


[0m[33;1m[1;3m
CREATE TABLE "Customer" (
	"CustomerId" INTEGER NOT NULL,
	"FirstName" NVARCHAR(40) NOT NULL,
	"LastName" NVARCHAR(20) NOT NULL,
	"Company" NVARCHAR(80),
	"Address" NVARCHAR(70),
	"City" NVARCHAR(40),
	"State" NVARCHAR(40),
	"Country" NVARCHAR(40),
	"PostalCode" NVARCHAR(10),
	"Phone" NVARCHAR(24),
	"Fax" NVARCHAR(24),
	"Email" NVARCHAR(60) NOT NULL,
	"SupportRepId" INTEGER,
	PRIMARY KEY ("CustomerId"),
	FOREIGN KEY("SupportRepId") REFERENCES "Employee" ("EmployeeId")
)

/*
3 rows from Customer table:
CustomerId	FirstName	LastName	Company	Address	City	State	Country	PostalCode	Phone	Fax	Email	SupportRepId
1	Lu├нs	Gon├зalves	Embraer - Empresa Brasileira de Aeron├бutica S.A.	Av. Brigadeiro Faria Lima, 2170	S├гo Jos├й dos Campos	SP	Brazil	12227-000	+55 (12) 3923-5555	+55 (12) 3923-5566	luisg@embraer.com.br	3
2	Leonie	K├╢hler	None	Theodor-Heuss-Stra├Яe 34	Stuttgart	None	Germany	70174	+49 0711 2842222	None	leonekohler@surfeu.de	5
3	Fran├зois	Tremblay	None	1498 rue B├йlanger	Montr├йal	QC	Canada	H2G 1A7	+1 (514) 721-4711	None	ftremblay@gmail.com	3
*/


CREATE TABLE "Invoice" (
	"InvoiceId" INTEGER NOT NULL,
	"CustomerId" INTEGER NOT NULL,
	"InvoiceDate" DATETIME NOT NULL,
	"BillingAddress" NVARCHAR(70),
	"BillingCity" NVARCHAR(40),
	"BillingState" NVARCHAR(40),
	"BillingCountry" NVARCHAR(40),
	"BillingPostalCode" NVARCHAR(10),
	"Total" NUMERIC(10, 2) NOT NULL,
	PRIMARY KEY ("InvoiceId"),
	FOREIGN KEY("CustomerId") REFERENCES "Customer" ("CustomerId")
)

/*
3 rows from Invoice table:
InvoiceId	CustomerId	InvoiceDate	BillingAddress	BillingCity	BillingState	BillingCountry	BillingPostalCode	Total
1	2	2009-01-01 00:00:00	Theodor-Heuss-Stra├Яe 34	Stuttgart	None	Germany	70174	1.98
2	4	2009-01-02 00:00:00	Ullev├еlsveien 14	Oslo	None	Norway	0171	3.96
3	8	2009-01-03 00:00:00	Gr├йtrystraat 63	Brussels	None	Belgium	1000	5.94
*/[0m[32;1m[1;3m
Invoking: `sql_db_query` with `SELECT c.Country, SUM(i.Total) AS TotalSales FROM Invoice i JOIN Customer c ON i.CustomerId = c.CustomerId GROUP BY c.Country ORDER BY TotalSales DESC LIMIT 10;`
responded: To list the total sales per country, I can query the "Invoice" and "Customer" tables. I will join these tables on the "CustomerId" column and group the results by the "BillingCountry" column. Then, I will calculate the sum of the "Total" column to get the total sales per country. Finally, I will order the results in descending order of the total sales.

Here is the SQL query:

\```sql
SELECT c.Country, SUM(i.Total) AS TotalSales
FROM Invoice i
JOIN Customer c ON i.CustomerId = c.CustomerId
GROUP BY c.Country
ORDER BY TotalSales DESC
LIMIT 10;
\```

Now, I will execute this query to get the total sales per country.

[0m[36;1m[1;3m[('USA', 523.0600000000003), ('Canada', 303.9599999999999), ('France', 195.09999999999994), ('Brazil', 190.09999999999997), ('Germany', 156.48), ('United Kingdom', 112.85999999999999), ('Czech Republic', 90.24000000000001), ('Portugal', 77.23999999999998), ('India', 75.25999999999999), ('Chile', 46.62)][0m[32;1m[1;3mThe total sales per country are as follows:

1. USA: $523.06
2. Canada: $303.96
3. France: $195.10
4. Brazil: $190.10
5. Germany: $156.48
6. United Kingdom: $112.86
7. Czech Republic: $90.24
8. Portugal: $77.24
9. India: $75.26
10. Chile: $46.62

To answer the second question, the country whose customers spent the most is the USA, with a total sales of $523.06.[0m

[1m> Finished chain.[0m

```

```output
{'input': "List the total sales per country. Which country's customers spent the most?",
 'output': 'The total sales per country are as follows:\n\n1. USA: $523.06\n2. Canada: $303.96\n3. France: $195.10\n4. Brazil: $190.10\n5. Germany: $156.48\n6. United Kingdom: $112.86\n7. Czech Republic: $90.24\n8. Portugal: $77.24\n9. India: $75.26\n10. Chile: $46.62\n\nTo answer the second question, the country whose customers spent the most is the USA, with a total sales of $523.06.'}
```

```python
agent_executor.invoke({"input": "Describe the playlisttrack table"})
```

```output


[1m> Entering new AgentExecutor chain...[0m
[32;1m[1;3m
Invoking: `sql_db_list_tables` with `{}`


[0m[38;5;200m[1;3mAlbum, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track[0m[32;1m[1;3m
Invoking: `sql_db_schema` with `PlaylistTrack`


[0m[33;1m[1;3m
CREATE TABLE "PlaylistTrack" (
	"PlaylistId" INTEGER NOT NULL,
	"TrackId" INTEGER NOT NULL,
	PRIMARY KEY ("PlaylistId", "TrackId"),
	FOREIGN KEY("TrackId") REFERENCES "Track" ("TrackId"),
	FOREIGN KEY("PlaylistId") REFERENCES "Playlist" ("PlaylistId")
)

/*
3 rows from PlaylistTrack table:
PlaylistId	TrackId
1	3402
1	3389
1	3390
*/[0m[32;1m[1;3mThe `PlaylistTrack` table has two columns: `PlaylistId` and `TrackId`. It is a junction table that represents the many-to-many relationship between playlists and tracks.

Here is the schema of the `PlaylistTrack` table:

\```

CREATE TABLE "PlaylistTrack" (
	"PlaylistId" INTEGER NOT NULL,
	"TrackId" INTEGER NOT NULL,
	PRIMARY KEY ("PlaylistId", "TrackId"),
	FOREIGN KEY("TrackId") REFERENCES "Track" ("TrackId"),
	FOREIGN KEY("PlaylistId") REFERENCES "Playlist" ("PlaylistId")
)

\```

The `PlaylistId` column is a foreign key referencing the `PlaylistId` column in the `Playlist` table. The `TrackId` column is a foreign key referencing the `TrackId` column in the `Track` table.

Here are three sample rows from the `PlaylistTrack` table:

\```

PlaylistId   TrackId
1            3402
1            3389
1            3390

\```

Please let me know if there is anything else I can help with.[0m

[1m> Finished chain.[0m
```

```output
{'input': 'Describe the playlisttrack table',
 'output': 'The `PlaylistTrack` table has two columns: `PlaylistId` and `TrackId`. It is a junction table that represents the many-to-many relationship between playlists and tracks. \n\nHere is the schema of the `PlaylistTrack` table:\n\n```\nCREATE TABLE "PlaylistTrack" (\n\t"PlaylistId" INTEGER NOT NULL, \n\t"TrackId" INTEGER NOT NULL, \n\tPRIMARY KEY ("PlaylistId", "TrackId"), \n\tFOREIGN KEY("TrackId") REFERENCES "Track" ("TrackId"), \n\tFOREIGN KEY("PlaylistId") REFERENCES "Playlist" ("PlaylistId")\n)\n```\n\nThe `PlaylistId` column is a foreign key referencing the `PlaylistId` column in the `Playlist` table. The `TrackId` column is a foreign key referencing the `TrackId` column in the `Track` table.\n\nHere are three sample rows from the `PlaylistTrack` table:\n\n```\nPlaylistId   TrackId\n1            3402\n1            3389\n1            3390\n```\n\nPlease let me know if there is anything else I can help with.'}
```

### рдЕрдЧрд▓реЗ рдХрджрдо

рдЕрднрд┐рдХрд░реНрддрд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдФрд░ рдЕрдиреБрдХреВрд▓рди рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП [Agents](/docs/use_cases/sql/agents) рдкреГрд╖реНрда рдкрд░ рдЬрд╛рдПрдВред
