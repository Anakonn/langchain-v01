---
sidebar_position: 4
translated: true
---

# ‡§¨‡§°‡§º‡•á ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏

‡§ï‡§ø‡§∏‡•Ä ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡•á ‡§ñ‡§ø‡§≤‡§æ‡§´ ‡§µ‡•à‡§ß ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ‡•á‡§Ç ‡§Æ‡•â‡§°‡§≤ ‡§ï‡•ã ‡§ü‡•á‡§¨‡§≤ ‡§®‡§æ‡§Æ, ‡§ü‡•á‡§¨‡§≤ ‡§∏‡•ç‡§ï‡•Ä‡§Æ‡§æ ‡§î‡§∞ ‡§´‡§º‡•Ä‡§ö‡§∞ ‡§Æ‡§æ‡§® ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§µ‡§π ‡§â‡§® ‡§™‡§∞ ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§ï‡§∞ ‡§∏‡§ï‡•á‡•§ ‡§ú‡§¨ ‡§ï‡§à ‡§ü‡•á‡§¨‡§≤, ‡§ï‡•â‡§≤‡§Æ ‡§î‡§∞/‡§Ø‡§æ ‡§â‡§ö‡•ç‡§ö-‡§ï‡§æ‡§∞‡•ç‡§°‡§ø‡§®‡•à‡§≤‡§ø‡§ü‡•Ä ‡§ï‡•â‡§≤‡§Æ ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§π‡§Æ‡§æ‡§∞‡•á ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§∞‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§π‡§∞ ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡§®‡§æ ‡§Ö‡§∏‡§Ç‡§≠‡§µ ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§ ‡§¨‡§¶‡§≤‡•á ‡§Æ‡•á‡§Ç, ‡§π‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ‡§∏‡§¨‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•ã ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§Ø‡§®‡•á‡§Æ‡§ø‡§ï‡§≤‡•Ä ‡§°‡§æ‡§≤‡§®‡•á ‡§ï‡•á ‡§§‡§∞‡•Ä‡§ï‡•á ‡§ñ‡•ã‡§ú‡§®‡•á ‡§π‡•ã‡§Ç‡§ó‡•á‡•§ ‡§ö‡§≤‡§ø‡§è ‡§á‡§∏ ‡§™‡§∞ ‡§ï‡•Å‡§õ ‡§§‡§ï‡§®‡•Ä‡§ï‡•ã‡§Ç ‡§™‡§∞ ‡§®‡§ú‡§º‡§∞ ‡§°‡§æ‡§≤‡§§‡•á ‡§π‡•à‡§Ç‡•§

## ‡§∏‡•á‡§ü‡§Ö‡§™

‡§™‡§π‡§≤‡•á, ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•à‡§ï‡•á‡§ú ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§ö‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç:

```python
%pip install --upgrade --quiet  langchain langchain-community langchain-openai
```

```output

[1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m23.2.1[0m[39;49m -> [0m[32;49m23.3.2[0m
[1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
Note: you may need to restart the kernel to use updated packages.
```

‡§π‡§Æ ‡§á‡§∏ ‡§ó‡§æ‡§á‡§° ‡§Æ‡•á‡§Ç OpenAI ‡§Æ‡•â‡§°‡§≤ ‡§ï‡§æ ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•Ä ‡§™‡§∏‡§Ç‡§¶ ‡§ï‡•á ‡§Æ‡•â‡§°‡§≤ ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ ‡§ï‡•ã ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

```python
import getpass
import os

# os.environ["OPENAI_API_KEY"] = getpass.getpass()

# Uncomment the below to use LangSmith. Not required.
os.environ["LANGCHAIN_API_KEY"] = getpass.getpass()
# os.environ["LANGCHAIN_TRACING_V2"] = "true"
```

```output
 ¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
```

‡§®‡•Ä‡§ö‡•á ‡§ï‡§æ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ SQLite ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§ó‡§æ Chinook ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§•‡•§ [‡§Ø‡•á ‡§∏‡•ç‡§•‡§æ‡§™‡§®‡§æ ‡§ö‡§∞‡§£](https://database.guide/2-sample-databases-sqlite/) ‡§ï‡§æ ‡§™‡§æ‡§≤‡§® ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§á‡§∏‡•Ä ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç `Chinook.db` ‡§¨‡§®‡§æ ‡§∏‡§ï‡•á‡§Ç:

* [‡§Ø‡§π ‡§´‡§º‡§æ‡§á‡§≤](https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite.sql) ‡§ï‡•ã `Chinook_Sqlite.sql` ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡•á‡§Ç
* `sqlite3 Chinook.db` ‡§ö‡§≤‡§æ‡§è‡§Ç
* `.read Chinook_Sqlite.sql` ‡§ö‡§≤‡§æ‡§è‡§Ç
* `SELECT * FROM Artist LIMIT 10;` ‡§ï‡§æ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç

‡§Ö‡§¨, `Chinhook.db` ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§π‡•à ‡§î‡§∞ ‡§π‡§Æ SQLAlchemy-driven [SQLDatabase](https://api.python.langchain.com/en/latest/utilities/langchain_community.utilities.sql_database.SQLDatabase.html) ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§á‡§∏‡§∏‡•á ‡§á‡§Ç‡§ü‡§∞‡§´‡§º‡•á‡§∏ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

```python
from langchain_community.utilities import SQLDatabase

db = SQLDatabase.from_uri("sqlite:///Chinook.db")
print(db.dialect)
print(db.get_usable_table_names())
db.run("SELECT * FROM Artist LIMIT 10;")
```

```output
sqlite
['Album', 'Artist', 'Customer', 'Employee', 'Genre', 'Invoice', 'InvoiceLine', 'MediaType', 'Playlist', 'PlaylistTrack', 'Track']
```

```output
"[(1, 'AC/DC'), (2, 'Accept'), (3, 'Aerosmith'), (4, 'Alanis Morissette'), (5, 'Alice In Chains'), (6, 'Ant√¥nio Carlos Jobim'), (7, 'Apocalyptica'), (8, 'Audioslave'), (9, 'BackBeat'), (10, 'Billy Cobham')]"
```

## ‡§ï‡§à ‡§ü‡•á‡§¨‡§≤

‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§è‡§ï ‡§ü‡•á‡§¨‡§≤ ‡§∏‡•ç‡§ï‡•Ä‡§Æ‡§æ ‡§π‡•à‡•§ ‡§ú‡§¨ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§æ‡§∏ ‡§¨‡§π‡•Å‡§§ ‡§∏‡§æ‡§∞‡•á ‡§ü‡•á‡§¨‡§≤ ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§π‡§Æ ‡§è‡§ï ‡§π‡•Ä ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§ï‡•Ä‡§Æ‡§æ ‡§ï‡•ã ‡§´‡§ø‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á‡•§ ‡§ê‡§∏‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§π‡§Æ ‡§ú‡•ã ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§µ‡§π ‡§Ø‡§π ‡§π‡•à ‡§ï‡§ø ‡§™‡§π‡§≤‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ü‡•á‡§¨‡§≤ ‡§®‡§æ‡§Æ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç, ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§ï‡•á‡§µ‡§≤ ‡§â‡§®‡§ï‡•Ä ‡§∏‡•ç‡§ï‡•Ä‡§Æ‡§æ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞‡•á‡§Ç‡•§

‡§ê‡§∏‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§Ü‡§∏‡§æ‡§® ‡§î‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§§‡§∞‡•Ä‡§ï‡§æ OpenAI ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®-‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó ‡§î‡§∞ Pydantic ‡§Æ‡•â‡§°‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§π‡•à‡•§ LangChain ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§¨‡§ø‡§≤‡•ç‡§ü-‡§á‡§® [create_extraction_chain_pydantic](https://api.python.langchain.com/en/latest/chains/langchain.chains.openai_tools.extraction.create_extraction_chain_pydantic.html) ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§π‡•à ‡§ú‡•ã ‡§π‡§Æ‡•á‡§Ç ‡§†‡•Ä‡§ï ‡§Ø‡§π‡•Ä ‡§ï‡§∞‡§®‡•á ‡§¶‡•á‡§§‡•Ä ‡§π‡•à:

```python
from langchain.chains.openai_tools import create_extraction_chain_pydantic
from langchain_core.pydantic_v1 import BaseModel, Field
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-3.5-turbo-1106", temperature=0)


class Table(BaseModel):
    """Table in SQL database."""

    name: str = Field(description="Name of table in SQL database.")


table_names = "\n".join(db.get_usable_table_names())
system = f"""Return the names of ALL the SQL tables that MIGHT be relevant to the user question. \
The tables are:

{table_names}

Remember to include ALL POTENTIALLY RELEVANT tables, even if you're not sure that they're needed."""
table_chain = create_extraction_chain_pydantic(Table, llm, system_message=system)
table_chain.invoke({"input": "What are all the genres of Alanis Morisette songs"})
```

```output
[Table(name='Genre'), Table(name='Artist'), Table(name='Track')]
```

‡§Ø‡§π ‡§ï‡§æ‡§´‡•Ä ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à! ‡§≤‡•á‡§ï‡§ø‡§®, ‡§ú‡•à‡§∏‡§æ ‡§ï‡§ø ‡§π‡§Æ ‡§®‡•Ä‡§ö‡•á ‡§¶‡•á‡§ñ‡•á‡§Ç‡§ó‡•á, ‡§π‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§î‡§∞ ‡§ü‡•á‡§¨‡§≤ ‡§≠‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§Ø‡§π ‡§Æ‡•â‡§°‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§ú‡§æ‡§®‡§®‡§æ ‡§ï‡§æ‡§´‡•Ä ‡§Æ‡•Å‡§∂‡•ç‡§ï‡§ø‡§≤ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§á‡§∏ ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç, ‡§π‡§Æ ‡§Æ‡•â‡§°‡§≤ ‡§ï‡•á ‡§ï‡§æ‡§Æ ‡§ï‡•ã ‡§∏‡§∞‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§¨‡§≤ ‡§ï‡•ã ‡§∏‡§Æ‡•Ç‡§π‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§®‡•á ‡§ï‡§æ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§π‡§Æ ‡§Æ‡•â‡§°‡§≤ ‡§∏‡•á "‡§∏‡§Ç‡§ó‡•Ä‡§§" ‡§î‡§∞ "‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø" ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ö‡•Å‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§π‡•á‡§Ç‡§ó‡•á, ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§µ‡§π‡§æ‡§Ç ‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§ü‡•á‡§¨‡§≤ ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á:

```python
system = """Return the names of the SQL tables that are relevant to the user question. \
The tables are:

Music
Business"""
category_chain = create_extraction_chain_pydantic(Table, llm, system_message=system)
category_chain.invoke({"input": "What are all the genres of Alanis Morisette songs"})
```

```output
[Table(name='Music')]
```

```python
from typing import List


def get_tables(categories: List[Table]) -> List[str]:
    tables = []
    for category in categories:
        if category.name == "Music":
            tables.extend(
                [
                    "Album",
                    "Artist",
                    "Genre",
                    "MediaType",
                    "Playlist",
                    "PlaylistTrack",
                    "Track",
                ]
            )
        elif category.name == "Business":
            tables.extend(["Customer", "Employee", "Invoice", "InvoiceLine"])
    return tables


table_chain = category_chain | get_tables  # noqa
table_chain.invoke({"input": "What are all the genres of Alanis Morisette songs"})
```

```output
['Album', 'Artist', 'Genre', 'MediaType', 'Playlist', 'PlaylistTrack', 'Track']
```

‡§Ö‡§¨ ‡§ú‡§¨ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§æ‡§∏ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§ü‡•á‡§¨‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§è‡§ï ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§π‡•à, ‡§§‡•ã ‡§π‡§Æ ‡§á‡§∏‡•á [create_sql_query_chain](https://api.python.langchain.com/en/latest/chains/langchain.chains.sql_database.query.create_sql_query_chain.html) ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§ú‡•ã `table_names_to_use` ‡§ï‡•Ä ‡§è‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§ø‡§è ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ü‡•á‡§¨‡§≤ ‡§∏‡•ç‡§ï‡•Ä‡§Æ‡§æ ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§ø‡§§ ‡§π‡•ã ‡§∏‡§ï‡•á‡§Ç:

```python
from operator import itemgetter

from langchain.chains import create_sql_query_chain
from langchain_core.runnables import RunnablePassthrough

query_chain = create_sql_query_chain(llm, db)
# Convert "question" key to the "input" key expected by current table_chain.
table_chain = {"input": itemgetter("question")} | table_chain
# Set table_names_to_use using table_chain.
full_chain = RunnablePassthrough.assign(table_names_to_use=table_chain) | query_chain
```

```python
query = full_chain.invoke(
    {"question": "What are all the genres of Alanis Morisette songs"}
)
print(query)
```

```output
SELECT "Genre"."Name"
FROM "Genre"
JOIN "Track" ON "Genre"."GenreId" = "Track"."GenreId"
JOIN "Album" ON "Track"."AlbumId" = "Album"."AlbumId"
JOIN "Artist" ON "Album"."ArtistId" = "Artist"."ArtistId"
WHERE "Artist"."Name" = 'Alanis Morissette'
```

```python
db.run(query)
```

```output
"[('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',), ('Rock',)]"
```

‡§π‡§Æ ‡§Ö‡§™‡§®‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•ã ‡§•‡•ã‡§°‡§º‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡§¨‡•ç‡§¶‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ï‡§π ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§â‡§§‡•ç‡§§‡§∞ ‡§Æ‡•á‡§Ç ‡§Ö‡§®‡§æ‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§¶‡•ã‡§π‡§∞‡§æ‡§µ ‡§π‡•ã

```python
query = full_chain.invoke(
    {"question": "What is the set of all unique genres of Alanis Morisette songs"}
)
print(query)
```

```output
SELECT DISTINCT g.Name
FROM Genre g
JOIN Track t ON g.GenreId = t.GenreId
JOIN Album a ON t.AlbumId = a.AlbumId
JOIN Artist ar ON a.ArtistId = ar.ArtistId
WHERE ar.Name = 'Alanis Morissette'
```

```python
db.run(query)
```

```output
"[('Rock',)]"
```

‡§π‡§Æ ‡§Ø‡§π‡§æ‡§Ç [LangSmith trace](https://smith.langchain.com/public/20b8ef90-1dac-4754-90f0-6bc11203c50a/r) ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

‡§π‡§Æ‡§®‡•á ‡§¶‡•á‡§ñ‡§æ ‡§π‡•à ‡§ï‡§ø ‡§ï‡§ø‡§∏ ‡§§‡§∞‡§π ‡§∏‡•á ‡§è‡§ï ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ü‡•á‡§¨‡§≤ ‡§∏‡•ç‡§ï‡•Ä‡§Æ‡§æ ‡§ï‡§æ ‡§è‡§ï ‡§â‡§™‡§∏‡§Æ‡•Ç‡§π ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§á‡§∏ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•ã ‡§π‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§î‡§∞ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ „Ç¢„Éó„É≠„Éº„ÉÅ ‡§Ø‡§π ‡§π‡•à ‡§ï‡§ø ‡§π‡§Æ ‡§è‡§ï ‡§è‡§ú‡•á‡§Ç‡§ü ‡§ï‡•ã ‡§ñ‡•Å‡§¶ ‡§§‡§¨ ‡§ü‡•á‡§¨‡§≤ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡§æ ‡§´‡•à‡§∏‡§≤‡§æ ‡§ï‡§∞‡§®‡•á ‡§¶‡•á‡§Ç ‡§ú‡§¨ ‡§â‡§∏‡•á ‡§ê‡§∏‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡•§ ‡§Ü‡§™ [SQL: ‡§è‡§ú‡•á‡§Ç‡§ü](/docs/use_cases/sql/agents) ‡§ó‡§æ‡§á‡§° ‡§Æ‡•á‡§Ç ‡§á‡§∏‡§ï‡§æ ‡§è‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

## ‡§â‡§ö‡•ç‡§ö-‡§ï‡§æ‡§∞‡•ç‡§°‡§ø‡§®‡•à‡§≤‡§ø‡§ü‡•Ä ‡§ï‡•â‡§≤‡§Æ

‡§†‡•Ä‡§ï ‡§∏‡•á ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ‡•á‡§Ç ‡§™‡§π‡§≤‡•á ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§ï‡§ø ‡§™‡§§‡•á, ‡§ó‡•Ä‡§§ ‡§®‡§æ‡§Æ ‡§Ø‡§æ ‡§ï‡§≤‡§æ‡§ï‡§æ‡§∞ ‡§ú‡•à‡§∏‡•á ‡§â‡§ö‡§ø‡§§ ‡§®‡§æ‡§Æ‡•ã‡§Ç ‡§µ‡§æ‡§≤‡•á ‡§ï‡•â‡§≤‡§Æ ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•Ä ‡§µ‡§∞‡•ç‡§§‡§®‡•Ä ‡§π‡•à‡•§

‡§è‡§ï ‡§®‡§æ‡§á‡§µ ‡§∞‡§£‡§®‡•Ä‡§§‡§ø ‡§Ø‡§π ‡§π‡•à ‡§ï‡§ø ‡§π‡§Æ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§∏‡§≠‡•Ä ‡§Ö‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø ‡§â‡§ö‡§ø‡§§ ‡§®‡§æ‡§Æ‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§µ‡•á‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç‡•§ ‡§´‡§ø‡§∞ ‡§π‡§Æ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡•á ‡§â‡§∏ ‡§µ‡•á‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡•ã ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§â‡§ö‡§ø‡§§ ‡§®‡§æ‡§Æ ‡§ï‡•ã ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

‡§™‡§π‡§≤‡•á ‡§π‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§á‡§ï‡§æ‡§à ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø ‡§Æ‡§æ‡§® ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à, ‡§ú‡§ø‡§∏‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§Æ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡•ã ‡§§‡§§‡•ç‡§µ‡•ã‡§Ç ‡§ï‡•Ä ‡§è‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§è‡§ï ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§ø‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç:

```python
import ast
import re


def query_as_list(db, query):
    res = db.run(query)
    res = [el for sub in ast.literal_eval(res) for el in sub if el]
    res = [re.sub(r"\b\d+\b", "", string).strip() for string in res]
    return res


proper_nouns = query_as_list(db, "SELECT Name FROM Artist")
proper_nouns += query_as_list(db, "SELECT Title FROM Album")
proper_nouns += query_as_list(db, "SELECT Name FROM Genre")
len(proper_nouns)
proper_nouns[:5]
```

```output
['AC/DC', 'Accept', 'Aerosmith', 'Alanis Morissette', 'Alice In Chains']
```

‡§Ö‡§¨ ‡§π‡§Æ ‡§Ö‡§™‡§®‡•á ‡§∏‡§≠‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§è‡§ï ‡§µ‡•á‡§ï‡•ç‡§ü‡§∞ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§è‡§Æ‡•ç‡§¨‡•á‡§° ‡§î‡§∞ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

```python
from langchain_community.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings

vector_db = FAISS.from_texts(proper_nouns, OpenAIEmbeddings())
retriever = vector_db.as_retriever(search_kwargs={"k": 15})
```

‡§î‡§∞ ‡§è‡§ï ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§™‡§π‡§≤‡•á ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡§§‡•Ä ‡§π‡•à:

```python
from operator import itemgetter

from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough

system = """You are a SQLite expert. Given an input question, create a syntactically \
correct SQLite query to run. Unless otherwise specificed, do not return more than \
{top_k} rows.\n\nHere is the relevant table info: {table_info}\n\nHere is a non-exhaustive \
list of possible feature values. If filtering on a feature value make sure to check its spelling \
against this list first:\n\n{proper_nouns}"""

prompt = ChatPromptTemplate.from_messages([("system", system), ("human", "{input}")])

query_chain = create_sql_query_chain(llm, db, prompt=prompt)
retriever_chain = (
    itemgetter("question")
    | retriever
    | (lambda docs: "\n".join(doc.page_content for doc in docs))
)
chain = RunnablePassthrough.assign(proper_nouns=retriever_chain) | query_chain
```

‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§ï‡•ã ‡§Ü‡§ú‡§º‡§Æ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ü‡§á‡§è ‡§¶‡•á‡§ñ‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø "elenis moriset", ‡§ú‡•ã Alanis Morissette ‡§ï‡§æ ‡§è‡§ï ‡§ó‡§≤‡§§ ‡§≤‡•á‡§ñ‡§® ‡§π‡•à, ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ ‡§î‡§∞ ‡§∏‡§æ‡§• ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§‡§ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à:

```python
# Without retrieval
query = query_chain.invoke(
    {"question": "What are all the genres of elenis moriset songs", "proper_nouns": ""}
)
print(query)
db.run(query)
```

```output
SELECT DISTINCT Genre.Name
FROM Genre
JOIN Track ON Genre.GenreId = Track.GenreId
JOIN Album ON Track.AlbumId = Album.AlbumId
JOIN Artist ON Album.ArtistId = Artist.ArtistId
WHERE Artist.Name = 'Elenis Moriset'
```

```output
''
```

```python
# With retrieval
query = chain.invoke({"question": "What are all the genres of elenis moriset songs"})
print(query)
db.run(query)
```

```output
SELECT DISTINCT Genre.Name
FROM Genre
JOIN Track ON Genre.GenreId = Track.GenreId
JOIN Album ON Track.AlbumId = Album.AlbumId
JOIN Artist ON Album.ArtistId = Artist.ArtistId
WHERE Artist.Name = 'Alanis Morissette'
```

```output
"[('Rock',)]"
```

‡§π‡§Æ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§‡§ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§π‡§Æ ‡§µ‡§∞‡•ç‡§§‡§®‡•Ä ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§è‡§ï ‡§µ‡•à‡§ß ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

‡§á‡§∏ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•ã ‡§π‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§î‡§∞ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§Ø‡§π ‡§π‡•à ‡§ï‡§ø ‡§π‡§Æ ‡§è‡§ï ‡§è‡§ú‡•á‡§Ç‡§ü ‡§ï‡•ã ‡§ñ‡•Å‡§¶ ‡§§‡§¨ ‡§â‡§ö‡§ø‡§§ ‡§®‡§æ‡§Æ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡§æ ‡§´‡•à‡§∏‡§≤‡§æ ‡§ï‡§∞‡§®‡•á ‡§¶‡•á‡§Ç ‡§ú‡§¨ ‡§â‡§∏‡•á ‡§ê‡§∏‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡•§ ‡§Ü‡§™ [SQL: ‡§è‡§ú‡•á‡§Ç‡§ü](/docs/use_cases/sql/agents) ‡§ó‡§æ‡§á‡§° ‡§Æ‡•á‡§Ç ‡§á‡§∏‡§ï‡§æ ‡§è‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
