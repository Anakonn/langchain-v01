---
sidebar_position: 1.5
title: рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ
translated: true
---

# LangChain рдХреЗ рд╕рд╛рде рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ

LLMs рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЙрддреНрддрд░рджрд╛рдпреА рдорд╣рд╕реВрд╕ рдХрд░рд╛рдиреЗ рдореЗрдВ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред

рдорд╣рддреНрд╡рдкреВрд░реНрдг LangChain рдкреНрд░рд╛рдердорд┐рдХрддрд╛рдПрдБ рдЬреИрд╕реЗ LLMs, рдкрд╛рд░реНрд╕рд░реНрд╕, рдкреНрд░реЙрдореНрдкреНрдЯреНрд╕, рд░рд┐рдЯреНрд░реАрд╡рд░реНрд╕, рдФрд░ рдПрдЬреЗрдВрдЯреНрд╕ LangChain [Runnable Interface](/docs/expression_language/interface) рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред

рдпрд╣ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╕рд╛рдордЧреНрд░реА рдХреЛ рд╕реНрдЯреНрд░реАрдо рдХрд░рдиреЗ рдХреЗ рджреЛ рд╕рд╛рдорд╛рдиреНрдп рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ:

1. рд╕рд┐рдВрдХ `stream` рдФрд░ рдЕрд╕рд┐рдВрдХ `astream`: рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╕реЗ **рдЕрдВрддрд┐рдо рдЖрдЙрдЯрдкреБрдЯ** рдХреЛ рд╕реНрдЯреНрд░реАрдо рдХрд░рдиреЗ рдХрд╛ рдПрдХ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди**ред
2. рдЕрд╕рд┐рдВрдХ `astream_events` рдФрд░ рдЕрд╕рд┐рдВрдХ `astream_log`: рдпреЗ рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╕реЗ **рдордзреНрдпрд╡рд░реНрддреА рдЪрд░рдгреЛрдВ** рдФрд░ **рдЕрдВрддрд┐рдо рдЖрдЙрдЯрдкреБрдЯ** рджреЛрдиреЛрдВ рдХреЛ рд╕реНрдЯреНрд░реАрдо рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред

рдЖрдЗрдП рджреЛрдиреЛрдВ рджреГрд╖реНрдЯрд┐рдХреЛрдгреЛрдВ рдкрд░ рдПрдХ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВ, рдФрд░ рдпрд╣ рд╕рдордЭрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ рдХрд┐ рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рдПред ЁЯе╖

## рд╕реНрдЯреНрд░реАрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛

рд╕рднреА `Runnable` рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ `stream` рдирд╛рдордХ рдПрдХ рд╕рд┐рдВрдХ рдореЗрдердб рдФрд░ `astream` рдирд╛рдордХ рдПрдХ рдЕрд╕рд┐рдВрдХ рд╡реЗрд░рд┐рдПрдВрдЯ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред

рдпреЗ рд╡рд┐рдзрд┐рдпрд╛рдБ рдЕрдВрддрд┐рдо рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдЯреБрдХрдбрд╝реЛрдВ рдореЗрдВ рд╕реНрдЯреНрд░реАрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХреА рдЧрдИ рд╣реИрдВ, рдкреНрд░рддреНрдпреЗрдХ рдЯреБрдХрдбрд╝реЗ рдХреЛ рдЬреИрд╕реЗ рд╣реА рдпрд╣ рдЙрдкрд▓рдмреНрдз рд╣реЛрддрд╛ рд╣реИ, рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред

рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХреЗрд╡рд▓ рддрднреА рд╕рдВрднрд╡ рд╣реИ рдЬрдм рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рд╕рднреА рдЪрд░рдг рдпрд╣ рдЬрд╛рдиреЗрдВ рдХрд┐ **рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдо** рдХреЛ рдХреИрд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП; рдпрд╛рдиреА, рдПрдХ рд╕рдордп рдореЗрдВ рдПрдХ рдЗрдирдкреБрдЯ рдЯреБрдХрдбрд╝реЗ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░реЗрдВ, рдФрд░ рдПрдХ рд╕рдВрдмрдВрдзрд┐рдд рдЖрдЙрдЯрдкреБрдЯ рдЯреБрдХрдбрд╝рд╛ рдкреНрд░рджрд╛рди рдХрд░реЗрдВред

рдЗрд╕ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЬрдЯрд┐рд▓рддрд╛ рднрд┐рдиреНрди рд╣реЛ рд╕рдХрддреА рд╣реИ, рдЬреИрд╕реЗ LLM рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдЯреЛрдХрди рдХреЛ рдЙрддреНрд╕рд░реНрдЬрд┐рдд рдХрд░рдирд╛ рдЬреИрд╕реЗ рд╕реАрдзреЗ рдХрд╛рд░реНрдп, рдпрд╛ рд╕рдВрдкреВрд░реНрдг JSON рдкреВрд░реНрдг рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ JSON рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рднрд╛рдЧреЛрдВ рдХреЛ рд╕реНрдЯреНрд░реАрдо рдХрд░рдирд╛ рдЬреИрд╕реЗ рдЪреБрдиреМрддреАрдкреВрд░реНрдг рдХрд╛рд░реНрдпред

рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреА рдЬрдЧрд╣ LLM рдРрдкреНрд╕ рдореЗрдВ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдШрдЯрдХреЛрдВ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░рдирд╛ рд╣реИ - рд╕реНрд╡рдпрдВ LLMs!

### LLMs рдФрд░ рдЪреИрдЯ рдореЙрдбрд▓

рдмрдбрд╝реЗ рднрд╛рд╖рд╛ рдореЙрдбрд▓ рдФрд░ рдЙрдирдХреЗ рдЪреИрдЯ рд╡реЗрд░рд┐рдПрдВрдЯ LLM рдЖрдзрд╛рд░рд┐рдд рдРрдкреНрд╕ рдореЗрдВ рдкреНрд░рд╛рдердорд┐рдХ рдмрд╛рдзрд╛ рд╣реИрдВред ЁЯЩК

рдмрдбрд╝реЗ рднрд╛рд╖рд╛ рдореЙрдбрд▓ рдХрд┐рд╕реА рдХреНрд╡реЗрд░реА рдХреЗ рд▓рд┐рдП рдкреВрд░реНрдг рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдореЗрдВ **рдХрдИ рд╕реЗрдХрдВрдб** рд▓реЗ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ **~200-300 ms** рд╕реАрдорд╛ рд╕реЗ рдХрд╣реАрдВ рдЕрдзрд┐рдХ рдзреАрдорд╛ рд╣реИ рдЬрд┐рд╕ рдкрд░ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рд╢реАрд▓ рдорд╣рд╕реВрд╕ рдХрд░рддрд╛ рд╣реИред

рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЕрдзрд┐рдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рд╢реАрд▓ рдорд╣рд╕реВрд╕ рдХрд░рд╛рдиреЗ рдХреА рдореБрдЦреНрдп рд░рдгрдиреАрддрд┐ рдордзреНрдпрд╡рд░реНрддреА рдкреНрд░рдЧрддрд┐ рджрд┐рдЦрд╛рдирд╛ рд╣реИ; рдЕрд░реНрдерд╛рдд, рдореЙрдбрд▓ рд╕реЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ **рдЯреЛрдХрди рджрд░ рдЯреЛрдХрди** рд╕реНрдЯреНрд░реАрдо рдХрд░рдирд╛ред

рд╣рдо [Anthropic](/docs/integrations/platforms/anthropic) рд╕реЗ рдЪреИрдЯ рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХреЗ рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рдПрдВрдЧреЗред рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ `langchain-anthropic` рдкреИрдХреЗрдЬ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рдЖрдк рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```python
pip install -qU langchain-anthropic
```

```python
# Showing the example using anthropic, but you can use
# your favorite chat model!
from langchain_anthropic import ChatAnthropic

model = ChatAnthropic()

chunks = []
async for chunk in model.astream("hello. tell me something about yourself"):
    chunks.append(chunk)
    print(chunk.content, end="|", flush=True)
```

```output
 Hello|!| My| name| is| Claude|.| I|'m| an| AI| assistant| created| by| An|throp|ic| to| be| helpful|,| harmless|,| and| honest|.||
```

рдЖрдЗрдП рдПрдХ рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░реЗрдВ

```python
chunks[0]
```

```output
AIMessageChunk(content=' Hello')
```

рд╣рдореЗрдВ рдХреБрдЫ рдорд┐рд▓рд╛ рдЬрд┐рд╕реЗ `AIMessageChunk` рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдЯреБрдХрдбрд╝рд╛ рдПрдХ `AIMessage` рдХрд╛ рдПрдХ рд╣рд┐рд╕реНрд╕рд╛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред

рд╕рдВрджреЗрд╢ рдЯреБрдХрдбрд╝реЗ рдбрд┐рдЬрд╝рд╛рдЗрди рджреНрд╡рд╛рд░рд╛ рдпреЛрдЧрд╛рддреНрдордХ рд╣реЛрддреЗ рд╣реИрдВ -- рдХреЗрд╡рд▓ рдЙрдиреНрд╣реЗрдВ рдЬреЛрдбрд╝рдХрд░ рдЕрдм рддрдХ рдХреА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рд╕реНрдерд┐рддрд┐ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ!

```python
chunks[0] + chunks[1] + chunks[2] + chunks[3] + chunks[4]
```

```output
AIMessageChunk(content=' Hello! My name is')
```

### рдЪреЗрди

рд▓рдЧрднрдЧ рд╕рднреА LLM рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдореЗрдВ рдПрдХ рднрд╛рд╖рд╛ рдореЙрдбрд▓ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдФрд░ рднреА рдХрджрдо рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВред

рдЖрдЗрдП `LangChain Expression Language` (`LCEL`) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╕рд░рд▓ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛рддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рдкреНрд░реЙрдореНрдкреНрдЯ, рдореЙрдбрд▓ рдФрд░ рдПрдХ рдкрд╛рд░реНрд╕рд░ рдХреЛ рдЬреЛрдбрд╝рддреА рд╣реИ рдФрд░ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрд╛рдо рдХрд░рддреА рд╣реИред

рд╣рдо рдореЙрдбрд▓ рд╕реЗ рдЖрдЙрдЯрдкреБрдЯ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `StrOutputParser` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред рдпрд╣ рдПрдХ рд╕рд░рд▓ рдкрд╛рд░реНрд╕рд░ рд╣реИ рдЬреЛ `AIMessageChunk` рд╕реЗ `рд╕рд╛рдордЧреНрд░реА` рдлрд╝реАрд▓реНрдб рдХреЛ рдирд┐рдХрд╛рд▓рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдореЗрдВ рдореЙрдбрд▓ рджреНрд╡рд╛рд░рд╛ рд▓реМрдЯрд╛рдП рдЧрдП `рдЯреЛрдХрди` рдорд┐рд▓рддреЗ рд╣реИрдВред

:::tip
LCEL рдПрдХ *рдШреЛрд╖рдгрд╛рддреНрдордХ* рддрд░реАрдХрд╛ рд╣реИ "рдХрд╛рд░реНрдпрдХреНрд░рдо" рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХрд╛, рд╡рд┐рднрд┐рдиреНрди LangChain рдкреНрд░рд╛рдердорд┐рдХрддрд╛рдУрдВ рдХреЛ рдПрдХ рд╕рд╛рде рдЬреЛрдбрд╝рдХрд░ред LCEL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рдИ рдЧрдИ рдЪреЗрди `stream` рдФрд░ `astream` рдХрд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИрдВ рдЬреЛ рдЕрдВрддрд┐рдо рдЖрдЙрдЯрдкреБрдЯ рдХреА рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВред рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, LCEL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рдИ рдЧрдИ рдЪреЗрди рдкреВрд░реЗ рдорд╛рдирдХ Runnable рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреА рд╣реИрдВред
:::

```python
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate

prompt = ChatPromptTemplate.from_template("tell me a joke about {topic}")
parser = StrOutputParser()
chain = prompt | model | parser

async for chunk in chain.astream({"topic": "parrot"}):
    print(chunk, end="|", flush=True)
```

```output
 Here|'s| a| silly| joke| about| a| par|rot|:|

What| kind| of| teacher| gives| good| advice|?| An| ap|-|parent| (|app|arent|)| one|!||
```

рдКрдкрд░ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ `parser` рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдореЙрдбрд▓ рд╕реЗ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдмрд▓реНрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдЯреБрдХрдбрд╝реЗ рдХреЛ рд╡реНрдпрдХреНрддрд┐рдЧрдд рд░реВрдк рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИред рдХрдИ [LCEL рдкреНрд░рд╛рдердорд┐рдХрддрд╛рдПрдВ](/docs/expression_language/primitives) рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рдЯреНрд░рд╛рдВрд╕рдлреЙрд░реНрдо-рд╕реНрдЯрд╛рдЗрд▓ рдкрд╛рд╕рдереНрд░реВ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреА рд╣реИрдВ, рдЬреЛ рдРрдкреНрд╕ рдмрдирд╛рдиреЗ рдореЗрдВ рдмрд╣реБрдд рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

рдХреБрдЫ рд░рдирдиреЗрдмрд▓реНрд╕, рдЬреИрд╕реЗ [рдкреНрд░реЙрдореНрдкреНрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕](/docs/modules/model_io/prompts) рдФрд░ [рдЪреИрдЯ рдореЙрдбрд▓](/docs/modules/model_io/chat), рд╡реНрдпрдХреНрддрд┐рдЧрдд рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рдФрд░ рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рд╕рднреА рдкрд┐рдЫрд▓реЗ рдЪрд░рдгреЛрдВ рдХреЛ рдПрдХрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВред рдпрд╣ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдмрд╛рдзрд┐рдд рдХрд░реЗрдЧрд╛ред рдХрд╕реНрдЯрдо рдХрд╛рд░реНрдп [рдЬрдирд░реЗрдЯрд░реНрд╕ рдХреЛ рд▓реМрдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ](/docs/expression_language/primitives/functions#streaming), рдЬреЛ

:::note
рдпрджрд┐ рдЙрдкрд░реЛрдХреНрдд рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдЖрдкрдХреЗ рдирд┐рд░реНрдорд╛рдг рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдкрдХреЛ LangChain рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `LangChain Expression Language` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ рдФрд░ рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдорд╛рдирдХ **рдЖрд╡рд╢реНрдпрдХ** рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
рдкреНрд░рддреНрдпреЗрдХ рдШрдЯрдХ рдкрд░ `invoke`, `batch` рдпрд╛ `stream` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ, рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░рдХреЗ рдФрд░ рдлрд┐рд░ рдЙрдиреНрд╣реЗрдВ рдЖрдЧреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред

рдпрджрд┐ рдпрд╣ рдЖрдкрдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдареАрдХ рд╣реИ ЁЯСМ!
:::

### рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдо рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛

рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдпрджрд┐ рдЖрдк JSON рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рд╕реЗ рд╕реНрдЯреНрд░реАрдо рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рдереЗ рдЬреИрд╕рд╛ рдХрд┐ рдпрд╣ рдЙрддреНрдкрдиреНрди рд╣реЛ рд░рд╣рд╛ рдерд╛?

рдпрджрд┐ рдЖрдк рдЖрдВрд╢рд┐рдХ JSON рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `json.loads` рдкрд░ рдирд┐рд░реНрднрд░ рд╣реЛрддреЗ, рддреЛ рдкрд╛рд░реНрд╕рд┐рдВрдЧ рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рддреА рдХреНрдпреЛрдВрдХрд┐ рдЖрдВрд╢рд┐рдХ JSON рдорд╛рдиреНрдп JSON рдирд╣реАрдВ рд╣реЛрддрд╛ред

рдЖрдк рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдпрд╣ рд╕реЛрдЪрдХрд░ рднреНрд░рдорд┐рдд рд╣реЛ рдЬрд╛рддреЗ рдХрд┐ JSON рдХреЛ рд╕реНрдЯреНрд░реАрдо рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рдерд╛ред

рдЦреИрд░, рдпрд╣ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реИ -- рдкрд╛рд░реНрд╕рд░ рдХреЛ **рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдо** рдкрд░ рдХрд╛рдо рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдФрд░ рдЖрдВрд╢рд┐рдХ JSON рдХреЛ рдорд╛рдиреНрдп рд╕реНрдерд┐рддрд┐ рдореЗрдВ "рд╕реНрд╡рддрдГ рдкреВрд░реНрдг" рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЖрдЗрдП рдРрд╕реЗ рдкрд╛рд░реНрд╕рд░ рдХреЛ рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рджреЗрдЦреЗрдВ рддрд╛рдХрд┐ рдпрд╣ рд╕рдордЭ рд╕рдХреЗрдВ рдХрд┐ рдЗрд╕рдХрд╛ рдХреНрдпрд╛ рдорддрд▓рдм рд╣реИред

```python
from langchain_core.output_parsers import JsonOutputParser

chain = (
    model | JsonOutputParser()
)  # Due to a bug in older versions of Langchain, JsonOutputParser did not stream results from some models
async for text in chain.astream(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`'
):
    print(text, flush=True)
```

```output
{}
{'countries': []}
{'countries': [{}]}
{'countries': [{'name': ''}]}
{'countries': [{'name': 'France'}]}
{'countries': [{'name': 'France', 'population': 67}]}
{'countries': [{'name': 'France', 'population': 6739}]}
{'countries': [{'name': 'France', 'population': 673915}]}
{'countries': [{'name': 'France', 'population': 67391582}]}
{'countries': [{'name': 'France', 'population': 67391582}, {}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': ''}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Sp'}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain'}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 4675}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 467547}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}, {}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}, {'name': ''}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}, {'name': 'Japan'}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}, {'name': 'Japan', 'population': 12}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}, {'name': 'Japan', 'population': 12647}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}, {'name': 'Japan', 'population': 1264764}]}
{'countries': [{'name': 'France', 'population': 67391582}, {'name': 'Spain', 'population': 46754778}, {'name': 'Japan', 'population': 126476461}]}
```

рдЕрдм, рдЖрдЗрдП рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХреЛ **рддреЛрдбрд╝реЗрдВ**ред рд╣рдо рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ рдФрд░ рдПрдХ рдирд┐рд╖реНрдХрд░реНрд╖рдг рдлрд╝рдВрдХреНрд╢рди рдЬреЛрдбрд╝реЗрдВрдЧреЗ рдЬреЛ рдЕрдВрддрд┐рдо JSON рд╕реЗ рджреЗрд╢ рдХреЗ рдирд╛рдо рдирд┐рдХрд╛рд▓рддрд╛ рд╣реИред

:::warning
рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ рдХреЛрдИ рднреА рдЪрд░рдг рдЬреЛ **рдЕрдВрддрд┐рдо рдЗрдирдкреБрдЯ** рдкрд░ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рди рдХрд┐ **рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдореНрд╕** рдкрд░, `stream` рдпрд╛ `astream` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рддреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИред
:::

:::tip
рдмрд╛рдж рдореЗрдВ, рд╣рдо `astream_events` API рдкрд░ рдЪрд░реНрдЪрд╛ рдХрд░реЗрдВрдЧреЗ рдЬреЛ рдордзреНрдпрд╡рд░реНрддреА рдЪрд░рдгреЛрдВ рд╕реЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рд╕реНрдЯреНрд░реАрдо рдХрд░рддрд╛ рд╣реИред рдпрд╣ API рдордзреНрдпрд╡рд░реНрддреА рдЪрд░рдгреЛрдВ рд╕реЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рд╕реНрдЯреНрд░реАрдо рдХрд░реЗрдЧрд╛ рднрд▓реЗ рд╣реА рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ рдРрд╕реЗ рдЪрд░рдг рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдЬреЛ рдХреЗрд╡рд▓ **рдЕрдВрддрд┐рдо рдЗрдирдкреБрдЯ** рдкрд░ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВред
:::

```python
from langchain_core.output_parsers import (
    JsonOutputParser,
)


# A function that operates on finalized inputs
# rather than on an input_stream
def _extract_country_names(inputs):
    """A function that does not operates on input streams and breaks streaming."""
    if not isinstance(inputs, dict):
        return ""

    if "countries" not in inputs:
        return ""

    countries = inputs["countries"]

    if not isinstance(countries, list):
        return ""

    country_names = [
        country.get("name") for country in countries if isinstance(country, dict)
    ]
    return country_names


chain = model | JsonOutputParser() | _extract_country_names

async for text in chain.astream(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`'
):
    print(text, end="|", flush=True)
```

```output
['France', 'Spain', 'Japan']|
```

#### рдЬрдирд░реЗрдЯрд░ рдлрдВрдХреНрд╢рдВрд╕

рдЖрдЗрдП рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХреЛ рдареАрдХ рдХрд░реЗрдВ рдПрдХ рдЬрдирд░реЗрдЯрд░ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬреЛ **рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдо** рдкрд░ рдХрд╛рдо рдХрд░ рд╕рдХрддрд╛ рд╣реИред

:::tip
рдПрдХ рдЬрдирд░реЗрдЯрд░ рдлрд╝рдВрдХреНрд╢рди (рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдЬреЛ `yield` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ) **рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдореНрд╕** рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдб рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
:::

```python
from langchain_core.output_parsers import JsonOutputParser


async def _extract_country_names_streaming(input_stream):
    """A function that operates on input streams."""
    country_names_so_far = set()

    async for input in input_stream:
        if not isinstance(input, dict):
            continue

        if "countries" not in input:
            continue

        countries = input["countries"]

        if not isinstance(countries, list):
            continue

        for country in countries:
            name = country.get("name")
            if not name:
                continue
            if name not in country_names_so_far:
                yield name
                country_names_so_far.add(name)


chain = model | JsonOutputParser() | _extract_country_names_streaming

async for text in chain.astream(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`'
):
    print(text, end="|", flush=True)
```

```output
France|Sp|Spain|Japan|
```

:::note
рдЪреВрдВрдХрд┐ рдЙрдкрд░реЛрдХреНрдд рдХреЛрдб JSON рдСрдЯреЛ-рдкреВрд░реНрдгрддрд╛ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реИ, рдЖрдк рджреЗрд╢реЛрдВ рдХреЗ рдЖрдВрд╢рд┐рдХ рдирд╛рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `Sp` рдФрд░ `Spain`), рдЬреЛ рдирд┐рд╖реНрдХрд░реНрд╖рдг рдкрд░рд┐рдгрд╛рдо рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдирд╣реАрдВ рдЪрд╛рд╣реЗрдЧрд╛!

рд╣рдо рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдЕрд╡рдзрд╛рд░рдгрд╛рдУрдВ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рди рдХрд┐ рдЖрд╡рд╢реНрдпрдХ рд░реВрдк рд╕реЗ рд╢реНрд░реГрдВрдЦрд▓рд╛рдУрдВ рдХреЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдкрд░ред
:::

### рдЧреИрд░-рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдШрдЯрдХ

рдХреБрдЫ рдирд┐рд░реНрдорд┐рдд рдШрдЯрдХ рдЬреИрд╕реЗ рд░рд┐рдЯреНрд░реАрд╡рд░реНрд╕ рдХреЛрдИ `рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ` рдкреЗрд╢ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред рдЕрдЧрд░ рд╣рдо рдЙрдиреНрд╣реЗрдВ `stream` рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ рддреЛ рдХреНрдпрд╛ рд╣реЛрдЧрд╛? ЁЯди

```python
from langchain_community.vectorstores import FAISS
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough
from langchain_openai import OpenAIEmbeddings

template = """Answer the question based only on the following context:
{context}

Question: {question}
"""
prompt = ChatPromptTemplate.from_template(template)

vectorstore = FAISS.from_texts(
    ["harrison worked at kensho", "harrison likes spicy food"],
    embedding=OpenAIEmbeddings(),
)
retriever = vectorstore.as_retriever()

chunks = [chunk for chunk in retriever.stream("where did harrison work?")]
chunks
```

```output
[[Document(page_content='harrison worked at kensho'),
  Document(page_content='harrison likes spicy food')]]
```

рд╕реНрдЯреНрд░реАрдо рдиреЗ рдЙрд╕ рдШрдЯрдХ рд╕реЗ рдЕрдВрддрд┐рдо рдкрд░рд┐рдгрд╛рдо рдХреЛ рд╣реА рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ред

рдпрд╣ рдареАрдХ рд╣реИ ЁЯе╣! рд╕рднреА рдШрдЯрдХреЛрдВ рдХреЛ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ -- рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдпрд╛ рддреЛ рдЕрдирд╛рд╡рд╢реНрдпрдХ рд╣реИ, рдХрдард┐рди рд╣реИ, рдпрд╛ рдмрд╕ рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖрддреА рд╣реИред

:::tip
рдЧреИрд░-рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдШрдЯрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рдИ рдЧрдИ рдПрдХ LCEL рд╢реНрд░реГрдВрдЦрд▓рд╛, рдХрдИ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЕрднреА рднреА рд╕реНрдЯреНрд░реАрдо рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧреА, рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ рдЕрдВрддрд┐рдо рдЧреИрд░-рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдЪрд░рдг рдХреЗ рдмрд╛рдж рдЖрдВрд╢рд┐рдХ рдЖрдЙрдЯрдкреБрдЯ рдХреА рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рд╢реБрд░реВ рд╣реЛрдЧреАред
:::

```python
retrieval_chain = (
    {
        "context": retriever.with_config(run_name="Docs"),
        "question": RunnablePassthrough(),
    }
    | prompt
    | model
    | StrOutputParser()
)
```

```python
for chunk in retrieval_chain.stream(
    "Where did harrison work? " "Write 3 made up sentences about this place."
):
    print(chunk, end="|", flush=True)
```

```output
 Based| on| the| given| context|,| the| only| information| provided| about| where| Harrison| worked| is| that| he| worked| at| Ken|sh|o|.| Since| there| are| no| other| details| provided| about| Ken|sh|o|,| I| do| not| have| enough| information| to| write| 3| additional| made| up| sentences| about| this| place|.| I| can| only| state| that| Harrison| worked| at| Ken|sh|o|.||
```

рдЕрдм рдЬрдм рд╣рдордиреЗ рджреЗрдЦрд╛ рдХрд┐ `stream` рдФрд░ `astream` рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдЗрдП рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдШрдЯрдирд╛рдУрдВ рдХреА рджреБрдирд┐рдпрд╛ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░реЗрдВред ЁЯПЮя╕П

## рд╕реНрдЯреНрд░реАрдо рдЗрд╡реЗрдВрдЯреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛

рдЗрд╡реЗрдВрдЯ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдПрдХ **рдмреАрдЯрд╛** API рд╣реИред рдпрд╣ API рдлреАрдбрдмреИрдХ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдереЛрдбрд╝рд╛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИред

:::note
langchain-core **0.1.14** рдореЗрдВ рдкреЗрд╢ рдХрд┐рдпрд╛ рдЧрдпрд╛ред
:::

```python
import langchain_core

langchain_core.__version__
```

```output
'0.1.18'
```

`astream_events` API рдХреЛ рдареАрдХ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдХреЛрдб рдореЗрдВ рдпрдерд╛рд╕рдВрднрд╡ `async` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрд╕рд┐рдВрдХ рдЙрдкрдХрд░рдг рдЖрджрд┐)
* рдХрд╕реНрдЯрдо рдХрд╛рд░реНрдп / рд░рдирдиреЗрдмрд▓реНрд╕ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╕рдордп рдХреЙрд▓рдмреИрдХреНрд╕ рдХреЛ рдкреНрд░рдЪрд╛рд░рд┐рдд рдХрд░реЗрдВ
* рдЬрдм рднреА LCEL рдХреЗ рдмрд┐рдирд╛ рд░рдирдиреЗрдмрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ, LLMs рдкрд░ `.ainvoke` рдХреЗ рдмрдЬрд╛рдп `.astream()` рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ LLM рдХреЛ рдЯреЛрдХрди рд╕реНрдЯреНрд░реАрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* рдпрджрд┐ рдХреБрдЫ рдЕрдкреЗрдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рддреЛ рд╣рдореЗрдВ рдмрддрд╛рдПрдВ! :)

### рдЗрд╡реЗрдВрдЯ рд╕рдВрджрд░реНрдн

рдиреАрдЪреЗ рдПрдХ рд╕рдВрджрд░реНрдн рддрд╛рд▓рд┐рдХрд╛ рджреА рдЧрдИ рд╣реИ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди Runnable рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдХреБрдЫ рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рджрд┐рдЦрд╛рддреА рд╣реИред

:::note
рдЬрдм рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХреЛ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдХрд┐рд╕реА runnable рдХреЗ рдЗрдирдкреБрдЯ рддрдм рддрдХ рдЬреНрдЮрд╛рдд рдирд╣реАрдВ рд╣реЛрдВрдЧреЗ рдЬрдм рддрдХ рдХрд┐ рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдо рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЙрдкрднреЛрдЧ рдирд╣реАрдВ рд╣реЛ рдЬрд╛рддреАред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ `inputs` рдЕрдХреНрд╕рд░ рдХреЗрд╡рд▓ `end` рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рд╢рд╛рдорд┐рд▓ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗ, рди рдХрд┐ `start` рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЗ рд▓рд┐рдПред
:::

| event                | name             | chunk                           | input                                         | output                                          |
|----------------------|------------------|---------------------------------|-----------------------------------------------|-------------------------------------------------|
| on_chat_model_start  | [model name]     |                                 | {"messages": [[SystemMessage, HumanMessage]]} |                                                 |
| on_chat_model_stream | [model name]     | AIMessageChunk(content="hello") |                                               |                                                 |
| on_chat_model_end    | [model name]     |                                 | {"messages": [[SystemMessage, HumanMessage]]} | {"generations": [...], "llm_output": None, ...} |
| on_llm_start         | [model name]     |                                 | {'input': 'hello'}                            |                                                 |
| on_llm_stream        | [model name]     | 'Hello'                         |                                               |                                                 |
| on_llm_end           | [model name]     |                                 | 'Hello human!'                                |
| on_chain_start       | format_docs      |                                 |                                               |                                                 |
| on_chain_stream      | format_docs      | "hello world!, goodbye world!"  |                                               |                                                 |
| on_chain_end         | format_docs      |                                 | [Document(...)]                               | "hello world!, goodbye world!"                  |
| on_tool_start        | some_tool        |                                 | {"x": 1, "y": "2"}                            |                                                 |
| on_tool_stream       | some_tool        | {"x": 1, "y": "2"}              |                                               |                                                 |
| on_tool_end          | some_tool        |                                 |                                               | {"x": 1, "y": "2"}                              |
| on_retriever_start   | [retriever name] |                                 | {"query": "hello"}                            |                                                 |
| on_retriever_chunk   | [retriever name] | {documents: [...]}              |                                               |                                                 |
| on_retriever_end     | [retriever name] |                                 | {"query": "hello"}                            | {documents: [...]}                              |
| on_prompt_start      | [template_name]  |                                 | {"question": "hello"}                         |                                                 |
| on_prompt_end        | [template_name]  |                                 | {"question": "hello"}                         | ChatPromptValue(messages: [SystemMessage, ...]) |

### рдЪреИрдЯ рдореЙрдбрд▓

рдЖрдЗрдП рдЪреИрдЯ рдореЙрдбрд▓ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдЗрд╡реЗрдВрдЯреНрд╕ рдкрд░ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВред

```python
events = []
async for event in model.astream_events("hello", version="v1"):
    events.append(event)
```

```output
/home/eugene/src/langchain/libs/core/langchain_core/_api/beta_decorator.py:86: LangChainBetaWarning: This API is in beta and may change in the future.
  warn_beta(
```

:::note

рдЕрд░реЗ рдпрд╣ API рдореЗрдВ version="v1" рдкреИрд░рд╛рдореАрдЯрд░ рдХреНрдпрд╛ рдордЬреЗрджрд╛рд░ рд╣реИ?! ЁЯШ╛

рдпрд╣ рдПрдХ **рдмреАрдЯрд╛ API** рд╣реИ, рдФрд░ рд╣рдо рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдЗрд╕рдореЗрдВ рдХреБрдЫ рдмрджрд▓рд╛рд╡ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред

рдпрд╣ рд╕рдВрд╕реНрдХрд░рдг рдкреИрд░рд╛рдореАрдЯрд░ рд╣рдореЗрдВ рдЖрдкрдХреЗ рдХреЛрдб рдореЗрдВ рдЗрд╕ рддрд░рд╣ рдХреЗ рддреЛрдбрд╝рдлреЛрдбрд╝ рд╡рд╛рд▓реЗ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рдиреНрдпреВрдирддрдо рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред

рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рд╣рдо рдЕрднреА рдЖрдкрдХреЛ рдкрд░реЗрд╢рд╛рди рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддрд╛рдХрд┐ рд╣рдореЗрдВ рдмрд╛рдж рдореЗрдВ рдЖрдкрдХреЛ рдкрд░реЗрд╢рд╛рди рди рдХрд░рдирд╛ рдкрдбрд╝реЗред
:::

рдЖрдЗрдП рдХреБрдЫ рд╕реНрдЯрд╛рд░реНрдЯ рдЗрд╡реЗрдВрдЯреНрд╕ рдФрд░ рдХреБрдЫ рдПрдВрдб рдЗрд╡реЗрдВрдЯреНрд╕ рдкрд░ рдирдЬрд░ рдбрд╛рд▓рддреЗ рд╣реИрдВред

```python
events[:3]
```

```output
[{'event': 'on_chat_model_start',
  'run_id': '555843ed-3d24-4774-af25-fbf030d5e8c4',
  'name': 'ChatAnthropic',
  'tags': [],
  'metadata': {},
  'data': {'input': 'hello'}},
 {'event': 'on_chat_model_stream',
  'run_id': '555843ed-3d24-4774-af25-fbf030d5e8c4',
  'tags': [],
  'metadata': {},
  'name': 'ChatAnthropic',
  'data': {'chunk': AIMessageChunk(content=' Hello')}},
 {'event': 'on_chat_model_stream',
  'run_id': '555843ed-3d24-4774-af25-fbf030d5e8c4',
  'tags': [],
  'metadata': {},
  'name': 'ChatAnthropic',
  'data': {'chunk': AIMessageChunk(content='!')}}]
```

```python
events[-2:]
```

```output
[{'event': 'on_chat_model_stream',
  'run_id': '555843ed-3d24-4774-af25-fbf030d5e8c4',
  'tags': [],
  'metadata': {},
  'name': 'ChatAnthropic',
  'data': {'chunk': AIMessageChunk(content='')}},
 {'event': 'on_chat_model_end',
  'name': 'ChatAnthropic',
  'run_id': '555843ed-3d24-4774-af25-fbf030d5e8c4',
  'tags': [],
  'metadata': {},
  'data': {'output': AIMessageChunk(content=' Hello!')}}]
```

### рдЪреЗрди

рдЖрдЗрдП рдЙрд╕ рдЙрджрд╛рд╣рд░рдг рдЪреЗрди рдкрд░ рдкреБрдирдГ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ рдЬрд┐рд╕рдиреЗ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ JSON рдХреЛ рдкрд╛рд░реНрд╕ рдХрд┐рдпрд╛ рдерд╛ рддрд╛рдХрд┐ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдЗрд╡реЗрдВрдЯреНрд╕ API рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗред

```python
chain = (
    model | JsonOutputParser()
)  # Due to a bug in older versions of Langchain, JsonOutputParser did not stream results from some models

events = [
    event
    async for event in chain.astream_events(
        'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`',
        version="v1",
    )
]
```

рдпрджрд┐ рдЖрдк рдкрд╣рд▓реЗ рдХреБрдЫ рдЗрд╡реЗрдВрдЯреНрд╕ рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ **2** рд╕реНрдЯрд╛рд░реНрдЯ рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЗ рдмрдЬрд╛рдп **3** рд╡рд┐рднрд┐рдиреНрди рд╕реНрдЯрд╛рд░реНрдЯ рдЗрд╡реЗрдВрдЯреНрд╕ рд╣реИрдВред

рдпреЗ рддреАрди рд╕реНрдЯрд╛рд░реНрдЯ рдЗрд╡реЗрдВрдЯреНрд╕ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рдЕрдиреБрд░реВрдк рд╣реИрдВ:

1. рдЪреЗрди (рдореЙрдбрд▓ + рдкрд╛рд░реНрд╕рд░)
2. рдореЙрдбрд▓
3. рдкрд╛рд░реНрд╕рд░

```python
events[:3]
```

```output
[{'event': 'on_chain_start',
  'run_id': 'b1074bff-2a17-458b-9e7b-625211710df4',
  'name': 'RunnableSequence',
  'tags': [],
  'metadata': {},
  'data': {'input': 'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`'}},
 {'event': 'on_chat_model_start',
  'name': 'ChatAnthropic',
  'run_id': '6072be59-1f43-4f1c-9470-3b92e8406a99',
  'tags': ['seq:step:1'],
  'metadata': {},
  'data': {'input': {'messages': [[HumanMessage(content='output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`')]]}}},
 {'event': 'on_parser_start',
  'name': 'JsonOutputParser',
  'run_id': 'bf978194-0eda-4494-ad15-3a5bfe69cd59',
  'tags': ['seq:step:2'],
  'metadata': {},
  'data': {}}]
```

рдЖрдкрдХреЛ рдХреНрдпрд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк рдЕрдВрддрд┐рдо 3 рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рджреЗрдЦреЗрдВ рддреЛ рдЖрдк рдХреНрдпрд╛ рджреЗрдЦреЗрдВрдЧреЗ? рдФрд░ рдмреАрдЪ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреНрдпрд╛?

рдЖрдЗрдП рдЗрд╕ API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдореЙрдбрд▓ рдФрд░ рдкрд╛рд░реНрд╕рд░ рд╕реЗ рд╕реНрдЯреНрд░реАрдо рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рд╣рдо рд╕реНрдЯрд╛рд░реНрдЯ рдЗрд╡реЗрдВрдЯреНрд╕, рдПрдВрдб рдЗрд╡реЗрдВрдЯреНрд╕ рдФрд░ рдЪреЗрди рд╕реЗ рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рдирдЬрд░рдЕрдВрджрд╛рдЬ рдХрд░ рд░рд╣реЗ рд╣реИрдВред

```python
num_events = 0

async for event in chain.astream_events(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`',
    version="v1",
):
    kind = event["event"]
    if kind == "on_chat_model_stream":
        print(
            f"Chat model chunk: {repr(event['data']['chunk'].content)}",
            flush=True,
        )
    if kind == "on_parser_stream":
        print(f"Parser chunk: {event['data']['chunk']}", flush=True)
    num_events += 1
    if num_events > 30:
        # Truncate the output
        print("...")
        break
```

```output
Chat model chunk: ' Here'
Chat model chunk: ' is'
Chat model chunk: ' the'
Chat model chunk: ' JSON'
Chat model chunk: ' with'
Chat model chunk: ' the'
Chat model chunk: ' requested'
Chat model chunk: ' countries'
Chat model chunk: ' and'
Chat model chunk: ' their'
Chat model chunk: ' populations'
Chat model chunk: ':'
Chat model chunk: '\n\n```'
Chat model chunk: 'json'
Parser chunk: {}
Chat model chunk: '\n{'
Chat model chunk: '\n '
Chat model chunk: ' "'
Chat model chunk: 'countries'
Chat model chunk: '":'
Parser chunk: {'countries': []}
Chat model chunk: ' ['
Chat model chunk: '\n   '
Parser chunk: {'countries': [{}]}
Chat model chunk: ' {'
...
```

рдХреНрдпреЛрдВрдХрд┐ рджреЛрдиреЛрдВ рдореЙрдбрд▓ рдФрд░ рдкрд╛рд░реНрд╕рд░ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ, рд╣рдо рджреЛрдиреЛрдВ рдШрдЯрдХреЛрдВ рд╕реЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдореЗрдВ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдЗрд╡реЗрдВрдЯреНрд╕ рджреЗрдЦрддреЗ рд╣реИрдВ! рдпрд╣ рдХреБрдЫ рд╣рдж рддрдХ рдХреВрд▓ рд╣реИ, рд╣реИ рди? ЁЯжЬ

### рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рдирд╛

рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ API рдмрд╣реБрдд рд╕рд╛рд░реЗ рдЗрд╡реЗрдВрдЯреНрд╕ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╡реЗрдВрдЯреНрд╕ рдкрд░ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рдирд╛ рдЙрдкрдпреЛрдЧреА рд╣реЛрддрд╛ рд╣реИред

рдЖрдк рдШрдЯрдХ `name`, рдШрдЯрдХ `tags` рдпрд╛ рдШрдЯрдХ `type` рджреНрд╡рд╛рд░рд╛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### рдирд╛рдо рджреНрд╡рд╛рд░рд╛

```python
chain = model.with_config({"run_name": "model"}) | JsonOutputParser().with_config(
    {"run_name": "my_parser"}
)

max_events = 0
async for event in chain.astream_events(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`',
    version="v1",
    include_names=["my_parser"],
):
    print(event)
    max_events += 1
    if max_events > 10:
        # Truncate output
        print("...")
        break
```

```output
{'event': 'on_parser_start', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': []}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{}]}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{'name': ''}]}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{'name': 'France'}]}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{'name': 'France', 'population': 67}]}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{'name': 'France', 'population': 6739}]}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{'name': 'France', 'population': 673915}]}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{'name': 'France', 'population': 67391582}]}}}
{'event': 'on_parser_stream', 'name': 'my_parser', 'run_id': 'f2ac1d1c-e14a-45fc-8990-e5c24e707299', 'tags': ['seq:step:2'], 'metadata': {}, 'data': {'chunk': {'countries': [{'name': 'France', 'population': 67391582}, {}]}}}
...
```

#### рдкреНрд░рдХрд╛рд░ рджреНрд╡рд╛рд░рд╛

```python
chain = model.with_config({"run_name": "model"}) | JsonOutputParser().with_config(
    {"run_name": "my_parser"}
)

max_events = 0
async for event in chain.astream_events(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`',
    version="v1",
    include_types=["chat_model"],
):
    print(event)
    max_events += 1
    if max_events > 10:
        # Truncate output
        print("...")
        break
```

```output
{'event': 'on_chat_model_start', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'input': {'messages': [[HumanMessage(content='output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`')]]}}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' Here')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' is')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' the')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' JSON')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' with')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' the')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' requested')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' countries')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' and')}}
{'event': 'on_chat_model_stream', 'name': 'model', 'run_id': '98a6e192-8159-460c-ba73-6dfc921e3777', 'tags': ['seq:step:1'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' their')}}
...
```

#### рдЯреИрдЧреНрд╕ рджреНрд╡рд╛рд░рд╛

:::caution

рдЯреИрдЧреНрд╕ рдПрдХ рджрд┐рдП рдЧрдП runnable рдХреЗ рдЪрд╛рдЗрд▓реНрдб рдШрдЯрдХреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рддреЗ рд╣реИрдВред

рдпрджрд┐ рдЖрдк рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреИрдЧреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдпрд╣ рд╡рд╣реА рд╣реИ рдЬреЛ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВред
:::

```python
chain = (model | JsonOutputParser()).with_config({"tags": ["my_chain"]})

max_events = 0
async for event in chain.astream_events(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`',
    version="v1",
    include_tags=["my_chain"],
):
    print(event)
    max_events += 1
    if max_events > 10:
        # Truncate output
        print("...")
        break
```

```output
{'event': 'on_chain_start', 'run_id': '190875f3-3fb7-49ad-9b6e-f49da22f3e49', 'name': 'RunnableSequence', 'tags': ['my_chain'], 'metadata': {}, 'data': {'input': 'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`'}}
{'event': 'on_chat_model_start', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'input': {'messages': [[HumanMessage(content='output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`')]]}}}
{'event': 'on_parser_start', 'name': 'JsonOutputParser', 'run_id': '3b5e4ca1-40fe-4a02-9a19-ba2a43a6115c', 'tags': ['seq:step:2', 'my_chain'], 'metadata': {}, 'data': {}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' Here')}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' is')}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' the')}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' JSON')}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' with')}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' the')}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' requested')}}
{'event': 'on_chat_model_stream', 'name': 'ChatAnthropic', 'run_id': 'ff58f732-b494-4ff9-852a-783d42f4455d', 'tags': ['seq:step:1', 'my_chain'], 'metadata': {}, 'data': {'chunk': AIMessageChunk(content=' countries')}}
...
```

### рдЧреИрд░-рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдШрдЯрдХ

рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдХреБрдЫ рдШрдЯрдХ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдореЗрдВ рдЕрдЪреНрдЫрд╛ рдкреНрд░рджрд░реНрд╢рди рдирд╣реАрдВ рдХрд░рддреЗ рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ **рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░реАрдореНрд╕** рдкрд░ рдХрд╛рд░реНрдп рдирд╣реАрдВ рдХрд░рддреЗ?

рдЬрдмрдХрд┐ рдРрд╕реЗ рдШрдЯрдХ `astream` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдЕрдВрддрд┐рдо рдЖрдЙрдЯрдкреБрдЯ рдХреА рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХреЛ рддреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ, `astream_events` рдЕрднреА рднреА рдЙрди рдордзреНрдпрд╡рд░реНрддреА рдЪрд░рдгреЛрдВ рд╕реЗ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдЗрд╡реЗрдВрдЯреНрд╕ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛ рдЬреЛ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ!

```python
# Function that does not support streaming.
# It operates on the finalizes inputs rather than
# operating on the input stream.
def _extract_country_names(inputs):
    """A function that does not operates on input streams and breaks streaming."""
    if not isinstance(inputs, dict):
        return ""

    if "countries" not in inputs:
        return ""

    countries = inputs["countries"]

    if not isinstance(countries, list):
        return ""

    country_names = [
        country.get("name") for country in countries if isinstance(country, dict)
    ]
    return country_names


chain = (
    model | JsonOutputParser() | _extract_country_names
)  # This parser only works with OpenAI right now
```

рдЬреИрд╕рд╛ рдХреА рдЕрдкреЗрдХреНрд╖рд┐рдд рдерд╛, `astream` API рд╕рд╣реА рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рдХреНрдпреЛрдВрдХрд┐ `_extract_country_names` рд╕реНрдЯреНрд░реАрдореНрд╕ рдкрд░ рдХрд╛рд░реНрдп рдирд╣реАрдВ рдХрд░рддрд╛ред

```python
async for chunk in chain.astream(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`',
):
    print(chunk, flush=True)
```

```output
['France', 'Spain', 'Japan']
```

рдЕрдм, рдЖрдЗрдП рдкреБрд╖реНрдЯрд┐ рдХрд░реЗрдВ рдХрд┐ astream_events рдХреЗ рд╕рд╛рде рд╣рдо рдЕрднреА рднреА рдореЙрдбрд▓ рдФрд░ рдкрд╛рд░реНрд╕рд░ рд╕реЗ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдЖрдЙрдЯрдкреБрдЯ рджреЗрдЦ рд░рд╣реЗ рд╣реИрдВред

```python
num_events = 0

async for event in chain.astream_events(
    'output a list of the countries france, spain and japan and their populations in JSON format. Use a dict with an outer key of "countries" which contains a list of countries. Each country should have the key `name` and `population`',
    version="v1",
):
    kind = event["event"]
    if kind == "on_chat_model_stream":
        print(
            f"Chat model chunk: {repr(event['data']['chunk'].content)}",
            flush=True,
        )
    if kind == "on_parser_stream":
        print(f"Parser chunk: {event['data']['chunk']}", flush=True)
    num_events += 1
    if num_events > 30:
        # Truncate the output
        print("...")
        break
```

```output
Chat model chunk: ' Here'
Chat model chunk: ' is'
Chat model chunk: ' the'
Chat model chunk: ' JSON'
Chat model chunk: ' with'
Chat model chunk: ' the'
Chat model chunk: ' requested'
Chat model chunk: ' countries'
Chat model chunk: ' and'
Chat model chunk: ' their'
Chat model chunk: ' populations'
Chat model chunk: ':'
Chat model chunk: '\n\n```'
Chat model chunk: 'json'
Parser chunk: {}
Chat model chunk: '\n{'
Chat model chunk: '\n '
Chat model chunk: ' "'
Chat model chunk: 'countries'
Chat model chunk: '":'
Parser chunk: {'countries': []}
Chat model chunk: ' ['
Chat model chunk: '\n   '
Parser chunk: {'countries': [{}]}
Chat model chunk: ' {'
Chat model chunk: '\n     '
Chat model chunk: ' "'
...
```

### рдХреЙрд▓рдмреИрдХреНрд╕ рдХреЛ рдкреНрд░рдЪрд╛рд░рд┐рдд рдХрд░рдирд╛

:::caution
рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдЯреВрд▓реНрд╕ рдХреЗ рдЕрдВрджрд░ runnables рдХреЛ рдмреБрд▓рд╛ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ runnable рдХреЛ рдХреЙрд▓рдмреИрдХреНрд╕ рдХреЛ рдкреНрд░рдЪрд╛рд░рд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛; рдЕрдиреНрдпрдерд╛, рдХреЛрдИ рд╕реНрдЯреНрд░реАрдо рдЗрд╡реЗрдВрдЯреНрд╕ рдЙрддреНрдкрдиреНрди рдирд╣реАрдВ рд╣реЛрдВрдЧреЗред
:::

:::note
рдЬрдм RunnableLambdas рдпрд╛ @chain рдбреЗрдХреЛрд░реЗрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдХреЙрд▓рдмреИрдХреНрд╕ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдкрд░реНрджреЗ рдХреЗ рдкреАрдЫреЗ рдкреНрд░рдЪрд╛рд░рд┐рдд рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред
:::

```python
from langchain_core.runnables import RunnableLambda
from langchain_core.tools import tool


def reverse_word(word: str):
    return word[::-1]


reverse_word = RunnableLambda(reverse_word)


@tool
def bad_tool(word: str):
    """Custom tool that doesn't propagate callbacks."""
    return reverse_word.invoke(word)


async for event in bad_tool.astream_events("hello", version="v1"):
    print(event)
```

```output
{'event': 'on_tool_start', 'run_id': 'ae7690f8-ebc9-4886-9bbe-cb336ff274f2', 'name': 'bad_tool', 'tags': [], 'metadata': {}, 'data': {'input': 'hello'}}
{'event': 'on_tool_stream', 'run_id': 'ae7690f8-ebc9-4886-9bbe-cb336ff274f2', 'tags': [], 'metadata': {}, 'name': 'bad_tool', 'data': {'chunk': 'olleh'}}
{'event': 'on_tool_end', 'name': 'bad_tool', 'run_id': 'ae7690f8-ebc9-4886-9bbe-cb336ff274f2', 'tags': [], 'metadata': {}, 'data': {'output': 'olleh'}}
```

рдпрд╣рд╛рдБ рдПрдХ рдкреБрди: рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╣реИ рдЬреЛ рдХреЙрд▓рдмреИрдХреНрд╕ рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдкреНрд░рдЪрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИред рдЖрдк рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рдЕрдм рд╣рдо `reverse_word` runnable рд╕реЗ рднреА рдЗрд╡реЗрдВрдЯреНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣реЗ рд╣реИрдВред

```python
@tool
def correct_tool(word: str, callbacks):
    """A tool that correctly propagates callbacks."""
    return reverse_word.invoke(word, {"callbacks": callbacks})


async for event in correct_tool.astream_events("hello", version="v1"):
    print(event)
```

```output
{'event': 'on_tool_start', 'run_id': '384f1710-612e-4022-a6d4-8a7bb0cc757e', 'name': 'correct_tool', 'tags': [], 'metadata': {}, 'data': {'input': 'hello'}}
{'event': 'on_chain_start', 'name': 'reverse_word', 'run_id': 'c4882303-8867-4dff-b031-7d9499b39dda', 'tags': [], 'metadata': {}, 'data': {'input': 'hello'}}
{'event': 'on_chain_end', 'name': 'reverse_word', 'run_id': 'c4882303-8867-4dff-b031-7d9499b39dda', 'tags': [], 'metadata': {}, 'data': {'input': 'hello', 'output': 'olleh'}}
{'event': 'on_tool_stream', 'run_id': '384f1710-612e-4022-a6d4-8a7bb0cc757e', 'tags': [], 'metadata': {}, 'name': 'correct_tool', 'data': {'chunk': 'olleh'}}
{'event': 'on_tool_end', 'name': 'correct_tool', 'run_id': '384f1710-612e-4022-a6d4-8a7bb0cc757e', 'tags': [], 'metadata': {}, 'data': {'output': 'olleh'}}
```

рдпрджрд┐ рдЖрдк Runnable Lambdas рдпрд╛ @chains рдХреЗ рднреАрддрд░ рд╕реЗ runnables рдХреЛ рдмреБрд▓рд╛ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдХреЙрд▓рдмреИрдХреНрд╕ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЖрдкрдХреА рдУрд░ рд╕реЗ рдкрд╛рд░рд┐рдд рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред

```python
from langchain_core.runnables import RunnableLambda


async def reverse_and_double(word: str):
    return await reverse_word.ainvoke(word) * 2


reverse_and_double = RunnableLambda(reverse_and_double)

await reverse_and_double.ainvoke("1234")

async for event in reverse_and_double.astream_events("1234", version="v1"):
    print(event)
```

```output
{'event': 'on_chain_start', 'run_id': '4fe56c7b-6982-4999-a42d-79ba56151176', 'name': 'reverse_and_double', 'tags': [], 'metadata': {}, 'data': {'input': '1234'}}
{'event': 'on_chain_start', 'name': 'reverse_word', 'run_id': '335fe781-8944-4464-8d2e-81f61d1f85f5', 'tags': [], 'metadata': {}, 'data': {'input': '1234'}}
{'event': 'on_chain_end', 'name': 'reverse_word', 'run_id': '335fe781-8944-4464-8d2e-81f61d1f85f5', 'tags': [], 'metadata': {}, 'data': {'input': '1234', 'output': '4321'}}
{'event': 'on_chain_stream', 'run_id': '4fe56c7b-6982-4999-a42d-79ba56151176', 'tags': [], 'metadata': {}, 'name': 'reverse_and_double', 'data': {'chunk': '43214321'}}
{'event': 'on_chain_end', 'name': 'reverse_and_double', 'run_id': '4fe56c7b-6982-4999-a42d-79ba56151176', 'tags': [], 'metadata': {}, 'data': {'output': '43214321'}}
```

рдФрд░ @chain рдбреЗрдХреЛрд░реЗрдЯрд░ рдХреЗ рд╕рд╛рде:

```python
from langchain_core.runnables import chain


@chain
async def reverse_and_double(word: str):
    return await reverse_word.ainvoke(word) * 2


await reverse_and_double.ainvoke("1234")

async for event in reverse_and_double.astream_events("1234", version="v1"):
    print(event)
```

```output
{'event': 'on_chain_start', 'run_id': '7485eedb-1854-429c-a2f8-03d01452daef', 'name': 'reverse_and_double', 'tags': [], 'metadata': {}, 'data': {'input': '1234'}}
{'event': 'on_chain_start', 'name': 'reverse_word', 'run_id': 'e7cddab2-9b95-4e80-abaf-4b2429117835', 'tags': [], 'metadata': {}, 'data': {'input': '1234'}}
{'event': 'on_chain_end', 'name': 'reverse_word', 'run_id': 'e7cddab2-9b95-4e80-abaf-4b2429117835', 'tags': [], 'metadata': {}, 'data': {'input': '1234', 'output': '4321'}}
{'event': 'on_chain_stream', 'run_id': '7485eedb-1854-429c-a2f8-03d01452daef', 'tags': [], 'metadata': {}, 'name': 'reverse_and_double', 'data': {'chunk': '43214321'}}
{'event': 'on_chain_end', 'name': 'reverse_and_double', 'run_id': '7485eedb-1854-429c-a2f8-03d01452daef', 'tags': [], 'metadata': {}, 'data': {'output': '43214321'}}
```
